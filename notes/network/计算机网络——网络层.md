本章主要将 IPv4 以及路由的相关知识。

# 网络层的功能

## 异构网络互联

要在全世界范围内吧数以百万计的网络互联起来，并且能够互联通信，是一项非常复杂的任务，此时需要解决许多问题，比如不同的寻址方案、不同的网络接入机制、不同的差错处理方法、不同的路由选择机制等。用户的需求是多样的，没有一种单一的网络能适应所有的需求。网络层所要完成的任务之一就是使这些异构的网络实现互联。

所谓网络互联，是将指两个以上的计算机网络，通过一定的方法，用一种或多种通信处理设备（即中间设备）互联起来，以构成更大的网络系统。中间设备又称中间系统或中断系统。

根据所在的层次，中继系统分为以下 4 种：

1. 物理层中继系统：中继器，集线器（Hub）。
2. 数据链路层中继系统：网桥或交换机。
3. 网络层中继系统：路由器。
4. 网络层以上的中继系统：网关。

使用物理层或数据链路层的中继系统时，只是把一个网络扩大了，而从网络层的角度看，它仍然是同一个网络，一般并不称之为网络互联。因此网络互联通常是指用路由器进行网络互联和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。

TCP/IP 体系在网络互联上采用的做法是在网络层（即 IP 层）采用标准化协议，但相互连接的网络可以是异构的。下图(a) 显示了许多计算机网络通过一些路由器进行的互联。由于参加互联的计算机网络都使用相同的网际协议（Internet Protocol，IP），因此可以把互联后的计算机网络视为下图(b) 所示的一个虚拟 IP 网络。

图片

虚拟互联网络也就是逻辑互联网络，即互联起来的各种物理网络的异构性本来是客观存在的，但是通过使用 IP 就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。这种使用 IP 的虚拟互联网络可简称为 IP 网络。

使用虚拟互联网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互联的具体的网络异构细节（如具体的编址方案、路由选择协议等）。

## 路由与转发

路由器主要完成两个功能：一是路由选择（确认哪一条路径），二是分组转发（当一个分组到达时所采取的动作）。前者是根据特定的路由选择协议构造出路由表。同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。后者处理通过路由器的数据流，关键操作时转发表查询、转发及相关的队列管理和任务调度等。

1. 路由选择。指按照复杂的分布式算法，根据从各相邻路由器所得到的的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
2. 分组转发。指路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。

路由表示根据路由选择算法得出的，而转发表示从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要对网络拓扑变化的计算最优化。在讨论路由选择的原理时，往往不去区分转发表和路由表，而是笼统地使用路由表一词。

## 拥塞控制

在通信子网中，因出现过量的分组而引起网络性能下降的现象称为拥塞。例如，某个路由器所在链路的带宽为 R B/s，如果 IP 分组只从它的某个端口进入，那么其速率为 $r_{in} \; B/s$。当 $r_{in} = R$ 时，可能看起来是件 “好事”，因为链路带宽被充分利用。但是，如下图所示，当分组到达路由器的速录接近 R 时，平均时延急剧增加，并且会有大量的分组被丢弃（路由器端口的缓冲区是有限的），整个网络的吞吐量会骤降，源与目的地之间的平均时延也会变得近乎无穷大。

判断网络是否进入拥塞状态的方法是，观察网络的吞吐量与网络负载的关系：如果随着网络负载的增加，网络的吞吐量明显小于正常的吞吐量，那么网络就可能已进入 “轻度拥塞” 状态；如果网络的吞吐量随着网络负载的增大而下降，那么网络就可能已进入拥塞状态；如果网络的负载继续增大，而网络的吞吐量下降到零，那么网络就可能已进入死锁状态。

为避免拥塞现象的出现，要采用能防止拥塞的一系列方法对子网进行拥塞控制。拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免由于拥塞而出现分组的丢失，以及严重拥塞而产生网络死锁的现象。

拥塞控制的作用是确保子网能够承载所达到的流量，这是一个全局性的过程，涉及各方面的行为：主机、路由器及路由器内部的转发处理过程等。单一地增加资源并不能解决拥塞。

**流量控制和拥塞控制的区别**：流量控制往往是指在发送端和接收端之间的点对点通信量的控制。流量控制所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。而拥塞控制必须确保通信子网能够传送待传送的数据，是一个全局性的问题，涉及网络中所有的主机、路由器及导致网络传输能力下降的所有因素。

拥塞控制的方法有两种：

1. 开环控制。在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。这是一种静态的预防方法。一旦整个系统启动并运行，中途就不再需要修改。开环控制手段包括确定何时可接收新流量、何时可丢弃分组及丢弃哪些分组，确定何种调度决策等。所有这些手段的共性是，在做决定时不考虑当前网络的状态。
2. 闭环控制。事先不考虑有关发生拥塞的各种因素，采用检测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。闭环控制是基于反馈环路的概念，是一种动态的方法。


# 路由算法

## 静态路由与动态路由

路由器转发分组是通过路由表转发的，而路由表示通过各种算法得到的。从能否随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可分为如下两大类。

静态路由算法（又称非自适应路由算法）。指由网络管理员手工配置的路由信息。当网络的拓扑结构或链路的状态发生变化时，网络管理员需要手工去修改路由表中相关的静态路由信息。大型和复杂的网络环境通常不宜采用静态路由。一方面，网络管理员难以全面地了解整个网络的拓扑结构；另一方面，当网络的拓扑结构和链路状态发生变化时，路由器中的静态路由信息需要大范围地调整，这一工作的难度和复杂程度非常高。

动态路由算法（又称自适应路由算法）。指路由器上的路由表项是通过相互连接的路由器之间彼此交换信息，然后按照一定的算法优化出来的，而这些路由信息会在一定时间间隙里不断更新，以适应不断变化的网络，以随时获得最优的寻路效果。

静态路由算法的优点是简便、可靠，在负荷稳定、拓扑变化不大的网络中运行效果很好，故仍广泛用于高度安全的军事系统和较小的商业网络。动态路由算法能改善网络的性能并有助于流量控制；但算法复杂，会增加网络的负担，有时因对动态变化的反应太快而引起振荡，或反应太慢而影响网络路由的一致性，因此要仔细设计动态路由算法，以发挥其优势。常用的动态路由算法可分为两类：距离-向量路由想法和链路状态路由算法。

## 距离-向量路由算法

在距离-向量路由算法中，所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点。这种路由选择表包含：

- 每条路径的目的地（另一结点）。
- 路径的代价（也称距离）。

注意：这里的距离是一个抽象的概念，如 RIP 就将距离定义为 “跳数”。跳数指从源端口到达目的端口所经过的路由个数，每经过一个路由器，跳数加 1。

在这种算法中，所有结点都必须参加与距离向量交换，以保证路由的有效性和一致性，也就是说，所有的结点都监听从其它结点传来的路由选择更新信息，并在下列情况下更新它们的路由选择表：

1. 被通告一条心的路由，该路由在本结点的路由表中不存在，此时本地系统加入这条心的路由。
2. 发来的路由信息中有一条到达某个目的地的路由，该路由与当前使用的路由相比，有较短的距离（较小的代价）。此种情况下，就用经过发送路由信息的结点的新路由替换路由表中到达那个目的地的现有路由。

距离-向量路由算法的实质是，迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短（最小代价）通路。它要求每个结点在每次更新时都将它的全部路由表发送给所有相邻的结点。显然，更细报文的大小与通信子网的结点个数成正比，大的通信子网将导致很大的更新报文。由于更新报文发送给直接邻接的结点，所以所有结点都将参加路由选择信息交换。基于这些原因，在通信子网上传送的路由选择信息的数量很容易变得非常大。

最常见的距离-向量路由算法是 RIP 算法，它采用 “跳数” 作为距离的度量。

## 链路状态路由算法

链路状态路由算法要求每个参与该算法的结点都具有完全的网络拓扑信息，它们执行下述两项任务。第一，主动测试所有邻接结点的状态。两个共享一条链接的结点是相邻结点，它们链接到同一条链路，或者链接到同一广播型物理网络。第二，定期地将链路状态传播给所有其它结点（或称路由结点）。典型的链路状态算法是 OSPF 算法。

在一个链路状态路由选择中，一个结点检查所有直接链路的状态，并将所得的状态信息发送给网上的所有其它结点，而不是仅送给那些直接相连的结点。每个结点都用这种方式从网上所有其它的结点接收包含直接链路状态的路由选择信息。

每当链路状态报文到达时，路由结点便使用这些状态信息去更新自己的网络拓扑和状态 “视野图”，一旦链路状态发生变化，结点就对更新的网络图利用 Dijsktra 最短路径算法重新计算路由，从单一的源出发计算到达所有目的结点的最短路径。

链路状态路由算法主要有三个特征：

1. 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法，即路由器通过所有端口向所有相邻的路由器发送信息。而每个相邻路由器又将此信息发往其所有相邻路由器（但不再发送给刚刚发来信息的那个路由器）。
2. 发送的信息是与路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓 “链路状态”，是指说明本路由器与哪些路由器相邻及该链路的 “度量”。对于 OSPF 算法，链路状态的 “度量” 主要用来表示费用、距离、时延、带宽等。
3. 只有当链路状态发生变化时，路由器才向所有路由器发送此消息。

由于一个路由器的链路状态只涉及相邻路由器的连通状态，而与整个互联网的规模并无直接关系，因此链路状态路由算法可以用于大型的或路由信息变化聚敛的互联网环境。

链路状态路由算法的主要优点是，每个路由结点都是用同样的原始状态数据独立地计算路径，而不依赖中间结点的计算：链路状态报文不加改变地传播，故采用该算法易于查找故障。当一个结点从所有其它结点接收到报文时，它可以在本地立即计算正确的通路，保证一步汇聚。最后，由于链路状态算法比距离-向量算法有更好的规模可伸展性。

**距离-向量路由算法与链路状态算法的比较**：在距离-向量路由算法汇总，每个结点仅与它的直接邻居交谈，它为它的邻居提供从自己到网络中所有其它结点的最低费用估计。在链路状态路由算法中，每个结点通过广播的方式与所有其它结点交谈，但它仅告诉它们与它直接相连的链路的费用。相比之下，距离-向量路由算法有可能遇到路由环路等问题。

## 层次路由

当网络规模扩大时，路由器的路由表成比例低增大。这不仅会消耗越来越多的路由器缓冲区空间，而且需要用更多 CPU 时间来扫描路由表，用更多的带宽来交换路由状态信息。因此路由选择必须按照层次的方式进行。

因特网将整个互联网划分为许多较小的自治系统（注意一个自治系统中包含很多局域网），每个自治系统有权自主地决定本系统内应采用何种路由选择协议。如果两个自治系统需要通信，那么就需要一种在两个自治系统之间的协议来屏蔽这些差异。据此，因特网把路由选择协议划分为两大类：

1. 一个自治系统内部所使用的路由选择协议称为内部网关协议（IGP），也称域内路由选择，具体的协议由 RIP 和 OSPF 等。
2. 自治系统之间所使用的路由选择协议称为外部网关协议（EGP），也称域间路由选择，用在不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径。具体的协议由 BGP。

使用层次路由时，OSPF 将一个自治系统再划分为若干区域（Area），每个路由器都知道在本区域内如何将分组路由到目的地的细节，但不用知道其它区域的内部结构。

采用分层次划分区域的方法虽然会使交换信息的种类增多，但也会使 OSPF 协议更加复杂。但这样做却能使每个区域内部交换路由信息的通信量大大减小，因而使 OSPF 协议能够用于规模很大的自治系统中。

# IPv4

## IPv4 分组

IPv4 即现在普遍使用的 IP（版本 4）。IP 定义数据传输的基本单元 —— IP 分组及其确切的数据格式。IP 也包括一套规则，指明分组如何处理、错误怎样控制。特别是 IP 还包含非可靠投递的思想，以及与此关联的分组路由选择的思想。

**1. IPv4 分组的格式**

一个 IP 分组由首部和数据两部分组成。首部前一部分的长度固定，供 20B，是所有 IP 分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。IP 数据报的格式如下图所示。

IP 首部的部分重要字段含义如下：

1. 版本。指 IP的版本，目前广泛使用的版本号为 4。
2. 首部长度。占 4 位。以 32 位为单位，最大值为 60B（15×4B）。最常用的首部长度是 20B，此时不使用任何选项（即可选字段）。
3. 总长度。占 16 位。指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 $2^{16} -1 = 65535B$。以太网帧的最大传送单元（MTU）为1500B，因此当一个 IP 数据报封装成帧时，数据报的总长度（首部加数据）一定不能超过下面数据链路层的 MTU 值。
4. 标识。占 16 位。它是一个计数器，没产生一个数据报就加 1，并赋值给标识字段。但它并不是 “序号”（因为 IP 是无连接服务）。当一个数据报的长度超过网络的 MTU 时，必须分片，此时每个数据报片都复制一次标识号，以便能正确重装成原来的数据报。
5. 标志。占 3 位。标志字段的最低位为 MF，MF = 1 表示后面还有分片，MF = 0 表示最后一个分片。标志字段中的一位是 DF，只有当 DF = 0 时才允许分片。
6. 片偏移。占 13 位。它指出较长的分组在分片后，某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位，即每个分片的长度一定是 8B（64位）的整数倍。
7. 首部校验和。占 16 位。IP 数据报的首部校验和只校验分组的首部，而不校验数据部分。
8. 生存时间（TTL）。占 8 位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。路由器在转发分组前，先把 TTL 减 1。若 TTL 被减为 0，则该分组必须丢弃。
9. 协议。占 8 位。指出此分组携带的数据使用何种协议，即分组的数据部分应交给哪个传输协议，如 TCP、UDP 等。其中值为 6 表示 TCP，值为 17 表示 UDP。
10. 源地址字段。占 4B，标识接收方的 IP 地址。
11. 目的地址字段。占 4B，标识发送方的 IP 地址。

注意：在 IP 数据报首部中有三个关于长度的标记，一个是首部长度、一个是总长度、一个是片偏移，基本单位分别为 4B、1B、8B（这个一定要记住）。题目中经常会出现几个长度之间的加减运算。另外，读者要熟悉 IP 数据报首部的各个字段的意义和功能，但不需要记忆 IP 数据报的首部，正常情况下如果需要参考首部，题目都会直接给出。第 5 章学到的 TCP、UDP 的首部也是一样的。

**2. IP 数据报分片**

一个链路层数据报能承载的最大数据量称为最大传送单元（MTU）。因为 IP 数据报被封装在链路层数据报中，故链路层的 MTU 严格地限制着 IP 数据报的长度，而且在 IP 数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的 MTU。例如，以太网的 MTU 为 1500B，而许多广域网的 MTU 不超过 576B。当 IP 数据报的总长度大于链路 MTU 时，就需要将 IP 数据报中的数据分装在两个或多个较小的 IP 数据报中，这些较小的数据报称为片。

片在目的地的网络层被重装组装。目的主机使用 IP 首部中的标识、标志和片偏移字段来完成对片的重组。创建一个 IP 数据报时，源主机为该数据报加上一个标识号。当一个路由器需要将一个数据报分片时，形成的每个数据报（即片）都具有原始数据报的标识号。当目的主机收到来自同一发送主机的一批数据报时，它可以通过检查数据报的标识号来确定哪些数据报属于同一个原始数据报的片。IP 首部中的标志位有 3 比特，但只有后 2 比特有意义，分别是 MF 位（More Fragment）和 DF 位（Don't Fragment）。只有当 DF = 0 时，该 IP 数据报才可以被分片。MF 则用来告知目的主机该 IP 数据报是否为原始数据报的最后一个片。当 MF = 1 时，表示相应的原始数据报还有后续的片；当 MF = 0 时，表示该数据报是相应原始数据报的最后一个片。目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始 IP 数据报的哪个位置。

IP 分片涉及一定的计算。例如，一个长 4000B 的 IP 数据报（首部 20B，数据部分 3980B）到达一个路由器，需要转发到一条 MTU 为 1500B 的链路上。这意味着原始数据报中的 3980B 数据必须被分配到 3 个独立的片中（每片也是一个 IP 数据报）。假定原始数据报的标识号为 777，那么分成的 3 片如下图所示。可以看出，由于偏移值的单位是 8B，所以除最后一个片外，其它所有片中的有效数据载荷都是 8 的倍数。

**3. 网络层转发分组的流程**

网络层的路由器质性的分组转发算法如下：

1. 从数据报的首部提取目的主机的 IP 地址 D，得出目的网络地址 N。
2. 若网络 N 与此路由器直接相连，则把数据报直接交付给目的主机 D，这称为路由器的直接交付；否则是间接交付，质性步骤3。
3. 若路由表中有目的地址为 D 的特定主机路由（对特定的目的主机指明一个特定的路由，通常是为了控制或测试网络，或出于安全考虑才采用的），则把数据报传送给路由表中所指明的下一跳路由器；否则，执行步骤4。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行步骤5。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行步骤6。
6. 报告转发分组出错。

注意：得到下一跳路由器的 IP 地址后并不是直接将该地址填入待发送的数据报，而是将该 IP 地址转换成 MAC 地址（通过ARP），将其放到 MAC 帧首部中，然后根据这个 MAC 地址找到下一跳路由器。在不同网络中传送时，MAC 帧中的源地址和目的地址要发生变化，但是网桥在转发帧时，不改变帧的源地址，请注意区分。

## IPv4 地址与 NAT

**1. IPv4 地址**

连接到因特网上的每台主机（或路由器）都分配一个 32 比特的全球唯一标识符，即 IP 地址。传统的 IP 地址是分类的地址，分为 A、B、C、D、E 五类。

无论哪类 IP 地址，都由网络号和主机号两部分组成。即 `IP 地址::={<网络号>,<主机号>}`。其中网络号标志主机（或路由器）所连接的网络。一个网络号在整个因特网范围内必须是唯一的。主机号标志该主机（或路由器）。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个 IP 地址在整个因特网范围内是唯一的。

分类的 IP 地址如下图所示。

在各类 IP 地址中，有些 IP 地址具有特殊用途，不用做主机的 IP 地址：

- 主机号全为 0 表示本网络本身，如 202.98.174.0。
- 主机号全为 1 表示本网络的广播地址，有称直接广播地址，如 202.98.174.255。
- 127.0.0.0 保留为环路自检（Loopback Test）地址，此地址表示任意主机本身，目的地址为环回地址的 IP 数据报永远不会出现在任何网络上。
- 32 位全为 0，即 0.0.0.0 表示本网络上的本主机。
- 32 位全为 1，即 255.255.255.255 表示整个 TCP/IP 网络的广播地址，又称首先广播地址。

实际使用时，由于路由器对广播域的隔离，255.255.255.255 等效为本网络的广播地址。

常用的三种类别 IP 地址的使用范围见下表。

|网络类别|最大可用网络数|第一个可用的网络号|最后一个可用的网络号|每个网络中的最大主机|
|:---:|:---:|:---:|:---:|:---:|
|A|$2^7-2$|1|126|$2^{24}-2$|
|B|$2^{14}-1$|128.1|191.255|$2^{16}-2$|
|C|$2^{21}-1$|192.0.1|223.255.255|$2^8-2$|

在上表中，A类地址可用的网络数为 $2^7-2$，减 2 的原因是：第一，网络号字段全为 0 的 IP 地址是保留地址，意思是 “本网络”；第二，网络号为 127 的 IP 地址是环回测试地址。B 类地址的可用网络数为 $2^{14}-1$，减 1 的原因是 128.0 这个网络号是不可指派的。C 类地址的可用网络数为 $2^{21}-1$，减 1 的原因是网络号为 192.0.0 的网络是不可指派的。

IP 地址有以下重要特点：

1. 每个 IP 地址都由网络号和主机号两部分组成，因此 IP 地址是一种分等地的地址结构。分等级的好处是：① IP 地址管理机构在分配 IP 地址时只分配网络号（第一级），而主机号（第二级）则由得到该网络的单位自行分配，方便了 IP 地址的管理；② 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目标主机号），从而减小了路由表所占的存储空间。
2. IP 地址是标志一台主机（或路由器）和一条链路的接口。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的 IP 地址，每个 IP 地址的网络号必须与所在网络的网络号相同，且这两个 IP 地址的网络号是不同的。因此 IP 网络上的一个路由其必然至少应具有两个 IP 地址（路由器每个端口必须至少分配一个 IP 地址）。
3. 用转发器或桥接器（网桥等）连接的若干 LAN 仍然是同一个网络（同一个广播域），因此该 LAN 中所有主机的 IP 地址的网络号必须相同，但主机号必须不同。
4. 在 IP 地址中，所有分配到网络号的网络（无论是 LAN 还是 WAN）都是平等的。
5. 在同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的。路由器总是具有两个或两个以上的 IP 地址，路由器的每个端口都有一个不同网络号的 IP 地址。

**2. 网络地址转换**

网络地址转换（NAT）是指通过将专用网络地址（如 Intranet）转换为公用地址（如 Internet），从而对外隐藏内部管理的 IP 地址。它使得整个专用网只需要一个全球 IP 地址就可以与因特网连通，由于专用网本地 IP 地址是可重用的，所以 NAT 大大节省了 IP 地址的消耗。同时，它隐藏了内部网络结果，从而降低了内部网络受到攻击的风险。

此外，为了网络安全，划出了部分 IP 地址为私有 IP 地址。私有 IP 地址只用于 LAN，不用于 WAN 连接（因此私有 IP 地址不能直接用于 Internet，必须通过网关利用 NAT 把私有 IP 地址转换为 Internet 中合法的全球 IP 地址后才能用于 Internet），并且允许私有 IP 地址被 LAN 重复使用。这有效地解决了 IP 地址不足的问题。私有 IP 地址网段如下：

- A类：1 个 A 类网段，即 10.0.0.0 ~ 10.255.255.255。
- B类：16 个 B 类网段，即 172.16.0.0 ~ 172.31.255.255。
- C类：256 个 C 类网段，即 192.168.0.0 ~ 192.168.255.255。

在因特网中的所有路由器，对目的地址是私有地址的数据报一律不进行转发。这种采用私有 IP 地址的互联网络称为专用互联网或本地互联网。私有 IP 地址也可称可重用地址。

使用 NAT 时需要在专用网连接到因特网的路由器上安装 NAT 软件，NAT 路由器至少有一个有效的外部全球地址。使用本地地址的主机和外界通信时，NAT 路由器使用 NAT 转换表将本地地址转换为全球地址，或将全球地址转换成本地地址。NAT 转换表中存放者着 `{本地 IP 地址 : 端口}` 到 `{全球 IP 地址 : 端口}` 的映射。通过 `{ip 地址 : 端口}` 这样的映射方式，就可以让多个私有 IP 地址映射到同一个全球 IP 地址。

下面以宿舍共享宽带上网为例进行说明。假设某个宿舍办理了 2Mb/s 的电信宽带，那么这个宿舍就获得了一个全球 IP 地址（如 138.76.29.7），而宿舍内 4 台主机使用私有地址（如 192.168.0.0 网段）。宿舍的网关路由器应该开启 NAT 功能，并且某时刻路由器上的 NAT 转换表见下表。那么，当路由器从 LAN 端口收到源 IP 及源端口号为 192.168.0.2:2233 的数据报时，就将其映射成 138.76.29.7:5001，然后从 WAN 端口发送到因特网上。当路由器从 WAN 端口收到目的 IP 及目的端口号为 138.76.29.7:5060 的数据报时，就将其映射成 192.168.0.3:1234，然后从 LAN 端口发送给相应的本地主机。这样，只需要一个全球地址，就可以让多态主机同时访问因特网。

注意：普通路由器在转发 IP 数据报时，不改变其源 IP 地址和目的 IP 地址。而 NAT 路由器在转发 IP 数据报时，一定要更换其 IP 地址（转换源 IP 地址或目的 IP 地址）。普通路由器仅工作在网络层，而 NAT 路由器转发数据报时需要查看和转换传输层的端口号。

## 子网划分与子网掩码、CIDR

**1. 子网划分**

两级 IP 地址的缺点：IP 地址空间的利用率有时很低；给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变坏；两级的 IP 地址不够灵活。

从 1985 年起，在 IP 地址中又增加了一个 “子网号字段”，使两级 IP 地址变成为三级 IP 地址。这种做法称为子网划分。子网划分已成为因特网的正是标准协议。

子网划分的基本思路如下：

- 子网划分纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。
- 从主机号借用若干比特作为子网号，当然主机号也就相应减少了相同的比特。三级 IP 地址的结构如下：`IP地址 = {<网络号>,<子网号>,<主机号>}`。
- 凡是从其它网络发送给本单位某台主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号，先找到连接到本单位网络上的路由器。然后该路由器在收到 IP 数据报后，按目的网络号和子网号找到目的子网。最后把 IP 数据报直接交付给目的主机。

注意：

1. 划分子网只是把 IP 地址的主机号这部分进行再划分，而不改变 IP 地址原来的网络号yinci.yinci，从一个 IP 地址本身或 IP 数据报的首部，无法判断源主机或UDID主机所连接的网络是否进行了子网划分。
2. [RFC 950] 规定，对分类的 IPv4 地址进行子网划分时，子网号不能全 1 或全 0。但随着 CIDR 的广泛使用，现在全 1 和全 0 的子网号也可使用，但一定要谨慎使用，要弄清你的路由器所用的路由选择软件是否支持全 0 或全 1 的子网号。
3. 不论是分类的 IPv4 地址还是 CIDR，其子网中的主机号为全 0 或全 1 的地址都不能被指派。子网中主机号全 0 的地址为子网的网络号，主机号全 1 的地址为子网的广播地址。

**2. 子网掩码**

为了告诉主机或路由器对一个 A 类、B 类、C 类网络进行了子网划分，使用子网掩码来表达对原网络中主机号的借位。

子网掩码是一个与 IP 地址相对应的、长 32 bit 的二进制串，它由一串 1 和跟随的一串 0 组成。其中，1 对应于 IP 地址中的网络号及子网号，而 0 对应于主机号。计算机只需将 IP 地址和其对应的子网掩码逐位 “与”（逻辑 AND 运算），就可得出相应子网的网络地址。

现在的因特网标准规定：所有的网络都必须使用子网掩码。如果一个网络未划分子网，那么就采用默认子网掩码。A、B、C 类地址的默认子网掩码分别是 255.0.0.0、255.255.0.0、255.255.255.0。例如，某主机的 IP 地址 192.168.5.56，子网掩码为 255.255.255.0，进行逐位 “与” 运算后，得出该主机所在子网的网络号为 192.168.5.0。

由于子网掩码是一个网络或一个子网的重要属性，所以路由器在相互之间交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉对方。路由表中的每个条目，除要给出目的网络地址和下一跳地址外，还要同时给出该目的网络的子网掩码。

在使用子网掩码的情况下：

1. 一台主机在设置 IP 地址信息的同时，必须设置子网掩码。
2. 同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码。
3. 路由器的路由表中，所包含信息的主要内容必须有目的网络地址、子网掩码、下一跳地址。

使用子网掩码时路由器的分组转发算法如下：

1. 从收到的分组的首部提取目的 IP 地址，记为 D。
2. 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和 D 逐位相 “与”，看结果是否和相应的网络地址匹配。若匹配，则将分组直接交付，否则就是间接交付，执行3。
3. 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给路由表中所指明的下一跳路由器；否则，执行 4。
4. 对路由表中的每一行（目的网络地址、子网掩码、下一跳地址）中的子网掩码和 D 逐位相 “与”，其结果为 N。若 N 与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则执行 5。
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行步骤 6。
6. 报告转发分组出错。

**3. 无分类域间路由选择（CIDR）**

无分类域间路由选择是在变长子网掩码的基础上提出的一种消除传统 A、B、C 类网络划分，并且可以在软件的支持下实现超网构造的一种 IP 地址的划分方法。

例如，如果一个单位需要 2000 个地址，那么就给它分配一个 2048 地址的块（8 个连续的 C 类网络），而不是一个完全的 B 类地址。这样可以大幅度提高 IP 地址空间的利用率，减小路由器的路由表大小，提高路由转发能力。CIDR 的主要特点如下：

1. 消除了传统 A、B、C 类地址及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。CIDR 使用 “网络前缀” 的概念代替子网络的概念。这样 IP 地址的无分类两级编址为：`IP::={<网络前缀>,<主机号>}`。
	CIDR 还使用 “斜线记法”（或称 CIDR 记法），即：IP地址/网络前缀所占比特数。其中，网络前缀所占比特数对应于网络号的部分，等效于子网掩码中连续 1 的部分。例如，对于 128.14.32.5/20 这个地址，它的掩码是 20 个连续的 1 和后续 12 个连续的 0，通过逐位相 “与” 的方法可以得到该地址的网络前缀（或直接截取前 20 位）：
	
	CIDR 虽然不使用子网，但仍然使用 “掩码” 一词。“CIDR 不使用子网” 是指 CIDR 并没有在 32 位地址中指明若干位作为子网字段。但分配到一个 CIDR 地址块的组织，仍可以在本组织内根据需要划分出一些子网。例如，某组织分配到地址块/20，就可以再继续划分为 8 个子网（从主机号中借用 3 位来划分子网），这时每个子网的网络前缀就变成了 23 位。全 0 和 全 1 的主机号地址一般不使用。

2. 将网络前缀都相同的连续 IP 地址组成 “CIDR 地址块”。一个 CIDR 地址块可以表示很多地址，这种地址的聚合称为路由聚合，或称构成超网。路由聚合使得路由表中的一个项目可以表示多个原来传统分类地址的路由，有利于减少路由器之间的路由选择信息的交换，从而提高网络性能。

例如，在如下图所示的网络中，如果不使用路由聚合，那么 R1 的路由表中需要分别有到网络 1 和网络 2 的路由表项。不难发现，网络 1 和网络 2 的网络前缀在二进制表示的情况下，前 16 位都是相同的，第 17 位分别是 0 和 1，并且从 R1 到网络 1 和网络 2 的路由的下一跳皆为 R2。若使用路由聚合，在 R1 看来，网络 1 和网络 2 可以构成一个更大的地址块 206.1.0.0/17，到网络 1 和网络 2 的两条路由就可以聚合成一条到 206.1.0.0/17 的路由。

CIDR 地址块中的地址数一定是 2 的整数次幂，实际可指派的地址通常为 $2^N-2$，N 表示主机号的位数，主机号全 0 代表网络号，主机号全 1 为广播地址。网络前缀越短，其地址块所包含的地址数就越多。而在三级结构的 IP 地址中，划分子网是使网络前缀变长。

CIDR 的优点在于网络前缀长度的灵活性。由于上层网络的前缀长度较短，因此相应的路由表的项目较少。而内部又可采用延长网络前缀的方法来灵活地划分子网。

最长前缀匹配（最佳匹配）：使用 CIDR 时，路由表中国的每个项目由 “网络前缀” 和 “下一跳地址” 组成。在查找路由表时可能会得到不止一个匹配结果。此时，应当从匹配结果中选择具有最长网络前缀的路由，因为网络前缀越长，其地址块就越小，因而路由就越具体。

CIDR 查找路由表的方法：为了更加有效地查找最长前缀匹配，通常将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。

## ARP、DHCP 与 ICMP

**1. IP 地址与硬件地址**

IP 地址是网络层使用的地址，它是分层次等级的。硬件地址是数据链路层使用的地址（如 MAC 地址），它是平面式的。在网络层及网络层之上使用 IP 地址，IP 地址放在 IP 数据报的首部，而 MAC 地址放在 MAC 帧的首部。通过数据封装，把 IP 数据报分组封装为 MAC 帧后，数据链路层看不见数据报分组中的 IP 地址。

由于路由器的隔离，IP 网络中无法通过广播方式依靠 MAC 地址来完成跨网站寻址，因此在 IP 网络的网络层只使用 IP 地址来完成寻址。寻址时，每个路由器依据其路由表（依靠静态路由或动态路由协议生成）选择到目标网络（即主机号全为 0 的网络地址）需要转发到下一跳（路由器的物理端口号或夏易网络地址），而 IP 分组通过多次路由转发到达目标网络后，改为在目标 LAN 中通过数据链路层的 MAC 地址以广播方式寻址。这样可以提高路由选择的效率。

1. 在 IP 层抽象的互联网上只能看到 IP 数据报。
2. 虽然在 IP 数据报首部中有完整的源 IP 地址和目标 IP 地址，但路由器只根据目的 IP 地址的网络号进行路由选择。
3. 在局域网的链路层，只能看见 MAC 帧。而通过路由器转发 IP 分组时，此 IP 分组在每个网络中都被路由器解封装和重新封装。因此 IP 数据报在被路由器转发时，其数据链路层封装所使用的 MAC 地址是不断改变的。这也决定了无法使用 MAC 地址跨网络通信。
4. 尽管互联网在一起的网络的硬件地址体系各不相同，但 IP 层抽象的互联网却屏蔽了下层这些复杂的细节。只要我们在网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机与主机或路由器之间的通信。

注意：路由器由于互联网多个网络，因此它不仅有多个 IP 地址，也有多个硬件地址。

**2. 地址解析协议（ARP）**

无论网络层使用什么协议，在实际网络的链路上传送数据帧时，最终必须使用硬件地址。所以需要一种方法来完成 IP 地址到 MAC 地址的映射，这就是地址解析协议（Address Resolution Protocol，ARP）。每台主机都设有一个 ARP 告诉缓存，用来存放本局域网上各主机和路由器的 IP 地址到 MAC 地址的映射表，称 ARP 表。使用 ARP 来动态维护此 ARP 表。

ARP 工作在网络层，其工作原理如下：主机 A 欲向本局域网上的某台主机 B 发送 IP 数据报时，先在其 ARP 告诉缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。如果没有，那么就通过使用目的 MAC 地址为 FF-FF-FF-FF-FF-FF 的帧来封装并广播 ARP 请求分组，使同一个局域网里的所有主机收到 ARP 请求。主机 B 收到该 ARP 请求后，向主机 A 发出响应 ARP 分组，分组中包含本机 B 的 IP 与 MAC 地址的映射关系，主机 A 在收到后将此映射写入 ARP 缓存，然后按查询到的硬件地址发送 MAC 帧。ARP 由于 “看到了” IP 地址，所以它工作在网络层，而 NAT路由器由于 “看到了” 端口，所以它工作在传输层。对于某个协议工作在哪个层次，读者应该能通过协议的工作原理进行猜测。

注意：ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做，尽管 ARP 请求分组是广播发送的，但 ARP 响应分组是普通的单播，即从一个源地址发送到一个目的地址。

ARP 的 4 中典型情况总结如下：

1. 发送方是主机时，要把 IP 数据报发送到本网络上的另一台主机。这时用 ARP 找到目的主机的硬件地址。
2. 发送方是主机时，要把 IP 数据报发送到另一个网络上的一台主机。这时用 ARP 找到本网络上的一个路由器的硬件地址，剩下的工作由这个路由器来完成。
3. 发送方是路由器时，要把 IP 数据报转发到本网络上的一台主机。这时用 ARP 找到目的主机的硬件地址。
4. 发送方是路由器时，要把 IP 数据报转发到另一个网络上的一台主机。这时用 ARP 找到本网络上的一个路由器的硬件地址，剩下的工作由找到的这个路由器完成。

从 IP 地址到硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程。只要主机或路由器和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 就会自动地将这个 IP 地址解析为链路层所需要的硬件地址。

**3. 动态主机配置协议（DHCP）**

动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）常用于给主机动态地分配 IP 地址，它提供了即插即用联网的机制，这种机制允许一台计算机加入新的网络和获取 IP 地址而不用手工参与。**DHCP 是应用层协议，它是基于 UDP 的**。

DHCP 的工作原理如下：使用客户/服务器方式。需要 IP 地址的主机在启动时就向 DHCP 服务器广播发送发现报文，这时该主机就成为 DHCP 客户。本地网络上所有主机都能收到此广播报文，但只有 DHCP 服务器才回答此广播报文。DHCP 服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的 IP 地址池中取出一个地址分配该计算机。DHCP 服务器的回答报文叫做提供报文。

DHCP 服务器聚合 DHCP 客户端的交换过程如下：

1. DHCP 客户机广播 “DHCP 发现” 消息，试图找到网络中的 DHCP 服务器，服务器获得一个 IP 地址。
2. DHCP 服务器收到 “DHCP 发现” 消息后，向网络中广播 “DHCP 提供” 消息，其中包括提供 DHCP 客户机的 IP 地址和相关配置信息。
3. DHCP 客户机收到 “DHCP 提供” 消息，如果接收 DHCP 服务器所提供的相关参数，那么通过广播  “DHCP 请求” 消息向 DHCP 服务器请求提供 IP 地址。
4. DHCP 服务器广播 “DHCP 确认” 消息，将 IP 地址分配给 DHCP 客户机。

DHCP 允许网络上配置多态 DHCP 服务器，当 DHCP 客户机发出 DHCP 请求时，有可能收到多个应答消息。这时，DHCP 客户机只会挑选其中一个，通常挑选最先到达的。

DHCP 服务器分配给 DHCP 客户的 IP 地址是临时的，因此 DHCP 客户只能在一段有限的时间内使用这个分配到的 IP 地址。DHCP 称这段时间为租用期。租用期的数值应由 DHCP 服务器自己决定，DHCP 客户也可在自己发送的报文中提出对租用期的要求。

DHCP 是应用层协议，因为它是通过客户/服务器方式工作的，DHCP 客户端向 DHCP 服务器请求服务。读者在后面的学习中会了解到，应用层协议由两种工作方式：客户/服务器方式和 P2P 方式，而其他层次的协议是没有这两种工作方式的。

DHCP 的客户端和服务器端需要通过广播方式来进行交互，原因是在 DHCP 执行期间，客户端和服务器端都没有标识自己身份的 IP 地址，因此不可能通过单播的形式进行交互。采用 UDP 而不采用 TCP 的原因也很明显，TCP 需要建立连接，如果连对方的 IP 地址都不知道，那么更不可能通过双方的套接字建立连接。

**4. 网际控制报文协议（ICMP）**

为了提高 IP 数据报交付成功的机会，在网络层使用了网际控制报文协议（Internet Control Message Protocol，ICMP）来让主机或路由器报告差错和异常情况。ICMP 报文作为 IP 数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。**ICMP 是 IP 层协议**。

ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文。

ICMP 差错报告报文用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况。共有以下 5 中类型：

1. 终点不可达。当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。
2. 源点抑制。当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
3. 时间超过。当路由器收到生存时间（TTL）为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
4. 参数问题。当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
5. 改变路由（重定向）。路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

不应发送 ICMP 差错报告报文的几种情况如下：

1. 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
2. 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
3. 对具有组播地址的数据报都不发送 ICMP 差错报告报文。
4. 对具有特殊地址（如 127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

ICMP 询问报文有 4 中类型：回送请求和回答报文、时间戳请求和回答报文、掩码地址请求和回答报文、路由器询问和通告报文，最常用的是前两类。

ICMP 的两个常见应用是分组网间探测 PING（用来测试两台主机之间的连通性）和 traceroute（UNIX 中的名字，在 Windows 中是 tracert，可以用来跟踪分组经过的路由）。其中 PING 使用了 ICMP 回送请求和回答报文，traceroute（Tracert）使用了 ICMP 时间超过报文。

注意：PING 工作在应用层，它直接使用网络层的 ICMP 协议，额人没有使用传输层的 TCP 或 UDP 协议。Traceroute/Tracert 工作在网络层。

# IPv6

## IPv6 的主要特点

解决 IP 地址耗尽问题的措施有以下三种：① 采用无类别编址 CIDR，使 Ip 地址的分配更加合理；② 采用网络地址转换（NAT）方法以节省全球 IP 地址；③ 采用具有更大地址空间的新版本的 IPv6。其中前两种方法只是延长了 IPv4 地址分配结束的时间，只有第三种方法从根本上解决了 IP 地址的耗尽问题。

IPv6 的主要特点如下：

1. 更大的地址空间。IPv6 将地址从 IPv4 的 32 位增大到了 128 位。IPv6 的字节数（16B）是 IPv4 字节数（4B）的平方。
2. 扩展的地址层次结构。
3. 灵活的首部格式。
4. 改进的选项。
5. 允许协议继续扩充。
6. 支持即插即用（即自动配置）。
7. 支持资源的预分配。
8. IPv6 只有在包的源结点才能分片，是端到端的，传输路径中的路由器不能分片，所以从一般意义上说，IPv6 不允许分片（不允许类似 IPv4 在路由分片）。
9. IPv6 首部长度必须是 8B 的整数倍，而 IPv4 首部是 4B 的整数倍。
10. 增大了安全性。身份验证和保密功能是 IPv6 的关键特征。

虽然 IPv6 与 IPv4 不兼容，但总体而言它与所有其他的因特网协议兼容包括 TCP、UDP、ICMP、IGMP、OSPF、BGP 和 DNS，只是在少数地方做了必要的修改（大部分是为了处理长的地址）。IPv6 相当好地满足了预定的目标，主要体现在：

1. 首先也是最重要的，IPv6 有比 IPv4 长的多的地址。IPv6 的地址用 16 个字节表示，地址空间是 IPv4 的 $2^{128-32}=2^{96}$倍，从长远来看，这些地址是绝对够用的。
2. 简化了 IP 分组头，它包含 8 个域（IPv4 是 12 个域）。这一改变使得路由器能够更快地处理分组，从而可以改善吞吐率。
3. 更好地支持选项。这一改变对新的分组首部很重要，因为一些从前必要的段现在变成了可选段。此外，表示选项的方式的改变还能加快分组的处理速度。


## IPv6 地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：

1. 单播。单播就是传统的点对点通信。
2. 多播。多播是一点对多点的通信，分组被交付到一组计算机的每一个。
3. 任播。这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一台计算机，通常是距离最近的一台计算机。

IPv4 地址通常使用点分十进制表示法。如果 IPv6 也使用这种表示法，那么地址书写起来将会相当长。在 IPv6 标准中指定了一种比较紧凑的表示法，即把地址中的每 4 位用一个十六进制数表示，并用冒号分隔每 16 位，如 4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170。

通常可以把 IPv6 地址缩写成更紧凑的形式。当 16 位域的开头由一些 0 时，可以采用一种缩写表示法，但在域中必须至少有一个数字。例如，可以把地址 4BF5:0000:0000:0000:BA5F:039A:000A:2176 缩写为 4BF5:0:0:0:BA5F:39A:A:2176。

当有相继的 0 值域时，还可以进一步缩写。这些域可以用双冒号缩写（`::`）。当然，双冒号表示法在一个地址中仅能出现一次，因为 0 值域的个数没有编码，需要从指定的总的域的个数来推算。这样一来，前述地址可被更紧凑地书写成 4BF5::BA5F:39A:A:2176。

IPv6 扩展了 IPv4 地址的分级概念，它使用以下 3 个等级：第一级（顶级）指明全球都知道的公共拓扑；第二级（场点级）指明单个场点；第三极指明单个网络接口。IPv6 地址采用多级体系主要是为了使路由器能够更快地查找路由。

IPv4 向 IPv6 过渡只能采用逐步演进的办法，同时还必须使新安装的 IPv6 系统能够向后兼容。IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。

IPv4 向 IPv6 过渡可以采用双协议栈和隧道技术两种策略：双协议栈是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）装有两个协议栈，一个 IPv4 和一个 IPv6，通过双协议栈进行转换；隧道技术是将整个 IPv6 数据报封装到 IPv4 数据报的数据部分，这样使得 IPv6 数据报可以在 IPv4 网络的隧道中传输。

# 路由协议

## 自治系统

自治系统（Autonomous System，AS）：单一技术管理下的一组路由器，这些路由器使用一种 AS 内部的路由选择协议和共同的度量来确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议来确定分组在 AS 之间的路由。

一个自治系统内的所有网络都由一个行政单位（如一家公司、一所大学、一个政府部门等）管辖，一个自治系统的所有路由器在本自治系统内都必须是连通的。

## 域内路由与域间路由

自治系统内部的路由选择称为域内路由选择，自治系统之间的路由选择称为域间路由选择。因特网有两大类路由选择协议。

**1. 内部网关协议（Interior Gateway Protocol，IGP）**

内部网关协议即在一个自治系统内部使用的路由选择协议，它与互联网中其它自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如 RIP 和 OSPF。

**2. 外部网关协议（External Gateway Protocol，EGP）**

若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时（两个自治系统可能使用不同的 IGP），就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议（EGP）。目前使用最多的外部网关协议是 BGP-4。

下图是两个自治系统互联的示意图。每个自治系统自己决定在本自治系统内部运行哪个内部路由选择协议（例如，可以是 RIP，也可以是 OSPF），但每个自治系统都有一个或多个路由器（图中的路由器 $R_1$ 和 $R_2$）。除运行本系统的内部路由选择协议外，还要运行自治系统间的路由选择协议（如 BGP-4）。

## 路由信息协议（RIP）

路由信息协议（Routing Information Protocol，RIP）是内部网关协议（IGP）中最先得到广泛应用的协议。RIP 是一种分布式的基于距离向量的路由选择协议，其最大优点就是简单。

**1. RIP 规定**

1. 网络中的每个路由器都要维护从它自身到其它每个目的网络的距离记录（因此这是一组距离，称为距离向量）。
2. 距离也称跳数（Hop Count），规定从一个路由器到直接连接网络的距离（跳数）为1。而每经过一个路由器，距离（跳数）加 1。
3. RIP 认为好的路由就是它通过的路由器的数目少，即优先选择跳数少的路径。
4. RIP 允许一条路径最多只能包含 15 个路由器（即最多允许 15 跳）。因此距离等于 16 时，它表示网络不可达。可见 RIP 只适用于小型互联网。距离向量路由可能会出现环路的情况，规定路径上的最高跳数的目的是为了防止数据报不断循环在环路上，减少网络拥塞的可能性。
5. RIP 默认在任意两个使用 RIP 的路由器之间每 30 秒广播一次 RIP 路由更新信息以便自动建立并维护路由表（动态维护）。
6. 在 RIP 中不支持子网掩码的 RIP 广播，所以 RIP 中每个网络的子网掩码必须相同。但在新的 RIP2 中，支持变长子网掩码和 CIDR。

**2. RIP 的特点（注意与 OSPF 的特点比较）**

1. 仅和相邻路由器交换信息。
2. 路由器交换的信息是当前路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息，如每隔 30 秒。

RIP 通过距离向量算法来完成路由表的更新。最初，每个路由器只知道与自己直接相连的网络。通过每 30 秒的 RIP 广播，相邻两个路由器相互将自己的路由表发给对方。于是经过第一次 RIP 广播，每个路由器就知道了与自己相邻的路由器的路由表（即知道了距离自己的跳数为 1 的网络的路由）。同理，经过第二次 RIP 广播，每个路由器就知道了距离自己跳数为 2 的网络的路由······因此经过若干 RIP 广播后，所有路由器都最终知道了整个 IP 网络的路由表，成为 RIP 最终是收敛的。通过 RIP 收敛后，每个路由器到每个目标网络的路由都是距离最短的（即跳数最少，最短路由），哪怕还存在另一条高速（低时延）但路由器较多的路由。

**3. 距离向量算法**

每个路由表项目都有三个关键数据：`<目的网络 N, 距离 d, 下一条路由器 X>`。对于每个相邻路由器发送过来的 RIP 报文，执行如下步骤：

1. 对地址为 X 的相邻路由器发来的 RIP 报文，先修改此报文中的所有项目：把 “下一跳” 字段中的地址都改为 X，并把所有 “距离” 字段的值加 1。
2. 对修改后的 RIP 报文中的每个项目，执行如下步骤：
	- ① 当原来的路由表总没有目的网络 N 时，把该项目添加到路由表中。
	- ② 当原来的路由表中有目的网络 N，且下一跳路由器的地址是 X 时，用收到的项目替换原路由表中的项目。
	- ③ 当原来的路由表中有目的网络 N，且下一跳路由器的地址不是 X 时，如果收到的项目中的距离 d 小于路由表中的距离，那么就用收到的项目替换原路由表中的项目，否则什么也不做。

3. 如果 180 秒（RIP 默认超时时间为 180 秒）还没有收到相邻路由器的更新	路由表，那么把此相邻路由器记为不可达路由器，即把距离设置为 16（距离为 16 表示不可达）。
4. 返回。

RIP 最大的优点是实现简单、开销小、收敛过程较快。RIP 的缺点如下：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大。
3. 网络出现故障时，会出现慢收敛现象（即需要较长时间才能将此信息传送到所有路由器），俗称 “坏消息传的慢”，使更新过程的收敛时间长。

RIP 是应用层协议，它使用 UDP 传送数据（端口 520）。RIP 选择的路径不一定是时间最短的，但一定是具有最少路由器的路径。因为它是根据最少的跳数进行路径选择的。

## 开放最短路径优先（OSPF）协议