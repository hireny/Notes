## 范式

关系数据库中的关系是要满足一定要求的，满足不同程度要求的为不同范式。满足最低要求的叫第一范式，简称 1NF。在第一范式中满足进一步要求的为第二范式，其余依次类推。

从范式来将，主要是 E.F. Codd 做的工作，1971~1972 年他系统地提出了 1NF、2NF、3NF 的概念，讨论了规范化的问题。1974 年，Codd 和 Boyce 又共同提出了一个新范式，即 BCNF。1976 年 Fagin 又提出了 4NF。后来又有人提出了 5NF。

本来，所谓 “第几范式”，是表示关系的某一种级别。所以经常称某一关系模式 R 为第几范式。现在把范式这个概念理解成符合某一种级别的关系模式的集合，即 R 为第几范式就可以写成 $R \in x$ NF。

对于各种范式之间的联系有

$$
5NF \subset 4NF \subset 3NF \subset 2NF \subset 1NF
$$

成立，如下图所示。

images 图 6.2 各种范式之间的联系

一个低一级范式的关系模式，通过模式分解（schema decomposition）可以转换为若干个高一级范式的关系模式的集合，这种过程就叫做规范化（normalization）。

## 2NF

定义 6.6 若 $R \in 1NF$，且每一个非主属性完全函数依赖于码，则 $R \in 2NF$。

下面举一个不是 2NF 的例子。

[例 4] 关系模型 S-L-C（Sno，Sdept，Sloc，Cno，Grade）

其中 Sloc 为学生的住处，并且每个系的学生住在同一个地方。S-L-C 的码为（Sno，Cno）。函数依赖有：

$$
(Sno, Cno) \stackrel{F}\longrightarrow Grade \\
Sno \longrightarrow Sdept,(Sno, Cno) \stackrel{P}\longrightarrow Sdept \\
Sno \longrightarrow Sloc,(Sno, Cno) \stackrel{P}\longrightarrow Sloc,
$$

$Sdept \longrightarrow Sloc $（因为每个系的学生只住一个地方），如图 6.3 所示。

images 图 6.3 函数依赖示例

图中用虚线表示部分函数依赖。另外，SDEPT 还函数决定 Sloc，这一点在讨论第二范式时暂不考虑。可以看到非主属性 Sdept、Sloc 并不完全函数依赖于码。因此 S-L-C（Sno，Sdept，Sloc，Cno，Grade）不符合 2NF 定义，即 $S-L-C \notin 2NF$。

一个关系模式 R 不属于 2NF，就会产生以下几个问题：

1. 插入异常。假若要插入一个学生 Sno = S7，Sdept=PHY，Sloc=BLD2，但该生还未选课，即这个学生无 Cno，这样的元组就插不进 S-L-C 中。因为插入元组时必须给定码值，而这时码值的一部分为空，因而学生的固有信息无法插入。
2. 删除异常。假定某个学生只选一门课，如 S4 就选了一门课 C3.现在 C3 这门课他也不选了，那么 C3 这个数据项就要删除。而 C3 是主属性，删除了 C3，整个元组就必须跟着删除，使得 S4 的其他信息也被删除了，从而造成删除异常，即不应删除的信息也删除了。
3. 修改复杂。某个学生从数学系（MA）转到计算机科学系（CS），这本来只需修改此学生元组中的 Sdept 分量。但因为关系模式 S-L-C 中还含有系的住处 Sloc 属性，学生转系将同时改变住处，因而还必须修改元组中的 Sloc 分量。另外，如果这个学生选修了 k 门课，Sdept，Sloc 重复存储了 k 次，不仅存储冗余度大，而且必须无遗漏地修改 k 个元组中全部 Sdept，Sloc 信息，造成修改的复杂化。

分析上面的例子，可以发现问题在于有两种非主属性。一种如 Grade，它对码是完全函数依赖。另一种如 Sdept、Sloc对码不是完全函数依赖。解决的办法是用投影分解把关系模式 S-L-C 分解为两个关系模式。

SC（Sno，Cno，Grade）
S-L（Sno，Sdept，Sloc）

关系模式 SC 与 S-L 中属性间的函数依赖可以用图 6.4、图 6.5 表示如下：

images 图 6.4 SC中的函数依赖

images 图 6.5 S-L 中的函数依赖

关系模式 SC 的码为（Sno，Cno），关系模式 S-L 的码为 Sno，这样就使得非主属性对码都是完全函数依赖了。

## 3NF

定义 6.8 关系模式 $R<U,F>$ 中若不存在这样的码 X，属性组 Y 及非主属性 Z（$X \notsubseteq Y$）使得 $X \longrightarrow Y$，$Y \longrightarrow Z$成立，$X \notlongrightarrow Y$，则称 $R < U$，$F > \in 3NF$。

由定义 6.7 可以证明，若 $R \in 3NF$，则每一个非主属性既不部分依赖于码也不传递依赖于码。

在图 6.4 中关系模式 SC 没有传递依赖，而图 6.5 中关系模式 S-L 存在非主属性对码的传递依赖。在 S-L 中，由 $Sno \longrightarrow Sdept$，（$SDept \notlongrightarrow Sno$），$Sdept \longrightarrow Sloc$，可得 $Sno \stackrel{传递}\longrightarrow Sloc$。因此 $SC \in 3NF$，而 $S-L \notin 3NF$。

一个关系模式 R 若不是 3NF，就会产生与2NF相类似的问题。读者可以类比 3NF 的反例加以说明。

解决的办法同样是将 S-L  分解为：

S-D（Sno，Sdept）
D-L（Sdept，Sloc）

分解后的关系模式 S-D 与 D-L 中不再存在传递依赖。

## BCNF

BCNF（Boyce Codd Normal Form）是由 Boyce 与 Codd 提出的，比上述的 3NF 有进了一步，通常认为 BCNF 是修正的第三范式，有时也称为扩充的第三范式。

定义 6.8 关系模式 $R<U,F> \in 1NF$。若 $X \longrightarrow Y$ 且 $Y \notsubseteq X$ 时 X 必含有码，则 $R<U,F> \in BCNF$。

也就是说，关系模式 $R<U,F>$中，若每一个决定因素都包含码，则 $R<U,F> \in BCNF$。

由 BCNF 的定义也可得出结论，一个满足 BCNF 的关系模式有：

- 所有非主属性对每一个码都是完全函数依赖；
- 所有的主属性对每一个不包含它的码，也是完全函数依赖；
- 没有任何属性完全函数依赖于非码的任何一组属性。

由于 $R \in BCNF$，按定义排除了任何属性对码的传递依赖与部分依赖，所以 $R \in 3NF$。严格的证明留给读者完成。但是若 $R \in 3NF$，则 R 未必属于 BCNF。

下面用几个例子证明说明属于 3NF 的关系模式有的属于 BCNF，但有的不属于 BCNF。

[例 5] 考察关系模式C（Cno，Cname，Pcno），它只有一个码 Cno，这里没有任何属性对 Cno 部分依赖或传递依赖，所以 $C \in 3NF$。同时 C 中 Cno 是唯一的决定因素，所以 $C \in BCNF$。对于关系模式 SC（Sno，Cno，Grade）可作同样分析。

[例 6] 关系关系 S（Sno，Sname，Sdept，Sage），假定 Sname 也具有唯一性，那么 S 就有两个码，这两个码都由单个属性组成，彼此不想交。其他属性不存在对码的传递依赖与部分依赖，所以 $S \in 3NF$。同时 S 中除 Sno，Sname 外没有其他决定因素，所以 S 也属于 BCNF。

以下再举几个例子。

[例 7] 关系模式 SJP（S，J，P）中，S是学生，J表示课程，P表示名次。每一个学生选修每门课程的成绩有一定的名次，每门课程中每一名次只有一个学生（即没有并列名次）。由语义可得到下面的函数依赖：

$$
(S,J) \longrightarrow P;(J,P) \longrightarrow S
$$

所以（S，J）与（J，P）都可以作为候选码。这两个码各由两个属性组成，并且它们是相交的。这个关系模式中显然没有属性对码传递依赖或部分依赖。所以 $SJP \in 3NF$，而且除（S，J）与（J，P）以外没有其他决定因素，所以 $SJP \in BCNF$。

[例 8] 关系模式 STJ（S，T，J）中，S表示学生，T表示教师，J表示课程。每一教师只教一门课。每门课有若干教师，某一学生选定某门课，就对应一个固定的教师。由语义可得到如下的函数依赖。

$(S,J) \longrightarrow T; (S,T) \longrightarrow J; T \longrightarrow J;$，用图 6.6 表示。

images 图 6.6 STJ 中的函数依赖

这里（S，J）、（S，T）都是候选码。

STJ 是 3NF，因为没有任何非主属性对码传递依赖或部分依赖。但 STJ 不是 BCNF 关系，因为 T 是决定因素，而T不包含码。

对于不是 BCNF 的关系模式，仍然存在不合适的地方。读者可自己距离指出 STJ 的不合适之处。非 BCNF 的关系模式也可以通过分解成为 BCNF。例如 STJ 可分解为 ST（S，T）与 TJ（T，J），它们都是 BCNF。

3NF 和 BCNF 是在函数依赖的条件下对模式分解所能达到的分离程度的测度。一个模式中的关系模式如果都属于 BCNF，那么在函数依赖范畴内，它已实现了彻底的分离，已消除了插入和删除的异常。3NF 的 “不彻底” 性表现在可能存在主属性对码的部分依赖和传递依赖。

## 多值依赖

以上完全是在函数依赖的范畴内讨论问题。属于 BCNF 的关系模式是否就很完美了呢？下面来看一个例子。

[例 9] 学校中某一门课程由多个教员讲授，他们使用相同的一套参考书。每个教员可以讲授多门课程，每种参考书可以供多门课程使用。可以用一个非规范化的关系来表示教员 T、课程 C 和参考书 B 之间的关系（如表 6.3 所示）。

images 表 6.3 非规范化关系示例

把这张表变成一张规范化的二维表，如表 6.4 所示。

关系模型 Teaching（C，T，B）的码是（C，T，B），即 All-Key。因而 $Teaching \in BCNF$。但是当某一课程（如物理）增加一名讲课教员（如周英）时，必须插入多个（这里是3个）元组：（物理，周英，普通物理学）； （物理，周英，光学原理）；（物理，周英，物理习题集）。

同样，某一门课（如数学）要去掉一本参考书（如微分方程），则必须删除多个（这里是两个）元组：（数学，李勇，微分方程）；（数学，张平，微分方程）。

对数据的增删改很不方便，数据的冗余也十分明显。仔细考察这类关系模型，发现它具有一种称之为多值依赖（Multi-Valued Dependency，MVD）的数据依赖。

定义 6.9 设 R(U) 是属于集 U 上的一个关系模型，X，Y，Z 是 U 的自己，并且 $Z = U-X-Y$。关系模型 R(U) 中的多值依赖 $X \longrightarrow\longrightarrow Y$成立，当且仅当对 R(U) 的任一关系 r，给定的一对 (x,z) 值，有一组 Y 的值，这组值仅仅决定于 x 值而与 z 值无关。

images 表 6.4 Teaching

例如，在关系模式 Teaching 中，对于一个（物理，光学原理）有一组 T 值 {李勇，王军}，这组值仅仅决定与课程 C 上的值（物理）。也就是说对于另一个（物理，普通物理学）它对应的一组 T 值仍是 {李勇，王军}，尽管这时参考书 B 的值已经改变了。因此 T 多值依赖于 C，即 $C \longrightarrow\longrightarrow T$。

对于多值依赖的另一个等价的形式化的定义是：

在 R(U) 的任一关系 r 中，如果存在元组 t，s 使得 t[X] = s[X]，那么就必然存在元组 $w，v \in r$，（w，v可以与s，t相同），使得 w[X] = v[X] = t[X]，而 w[Y] = t[Y]，w[Z] = s[Z]，v[Y] = s[Y]，v[Z] = t[Z]（即交换s，t元组的 Y 值所得的两个新元组必在r中），则Y多值依赖于X，记为 $X \longrightarrow\longrightarrow Y$。这里，X，Y是U的自己，Z=U-X-Y。

若$X \longrightarrow\longrightarrow Y$，而 Z = $\phi$ 即 Z为空，则称 $X \longrightarrow\longrightarrow Y$ 为平凡的多值依赖。

下面再举一个具有多值依赖的关系模式的例子。

[例 10] 关系模式 WSC（W，S，C）中，W表示仓库，S表示保管员，C表示商品。假设每个仓库有若干个保管员，有若干种商品。每个保管员保管所在的仓库的所有商品，每种商品被所有保管员保管。列出关系如下：

images 表

按照语义对于 W 的每一个值 $W_i$，S 有一个完整的集合与之对应而不问 C 取何值。所以 $W \longrightarrow\longrightarrow S$。

如果用图 6.7 来表示这种对应，则对应 W 的某一个值 $W_i$ 的全部S值记作 ${S}_{Wi}$（表示此仓库工作的全部保管员），全部C值记作 ${C}_{Wi}$（表示在此仓库中存放的所有商品）。应当有 ${S}_{Wi}$

## 4NF

定义 6.10 关系模式 $R<U,F> \in 1NF$，如果对于 R 的每个非平凡多值依赖 $X \longrightarrow\longrightarrow Y$（Y \notsubseteq Y），X都含有码，则称 $R<U,F> \in 4NF$。

4NF 就是限制关系模式的属性之间不允许有非平凡且非函数依赖的多值依赖。因为根据定义，对于么一个非平凡的多值依赖 $X \longrightarrow\longrightarrow Y$，X都含有候选码，于是就有 $X \longrightarrow Y$，所以 4NF 所允许的非平凡的多值依赖实际上是函数依赖。

显然，如果一个关系模式是 4NF，则必为 BCNF。

在前面讨论的而关系模式 WSC 中，$W \longrightarrow\longrightarrow S$，$W \longrightarrow\longrightarrow C$，它们都是非平凡的多值依赖。而 W 不是码，关系模式 WSC 的码是（W，S，C），即 All-Key。因此 $WSC \notin 4NF$。

一个关系模式如果已达到了 BCNF 但不是 4NF，这样的关系模式仍然具有不好的性质。以 WSC 为例，$WSC \notin 4NF$，但是 $WSC \in BCNF$。对于 WSC 的某个关系，若某一仓库 $W_i$ 有 n 个保管员，存放 m 件物品，则关系中分量为 $W_i$ 的元组数目一定有 m x n 个。每个保管员重复存储 m 次，每种物品重复存储 n 次，数据的冗余度太大，因此还应该继续规范化使关系模式 WSC 达到 4NF。

可以用投影分解的方法消去非平凡且非函数依赖的多值依赖。例如可以把 WSC 分解为 WS（W，S），WC（W，C）。在 WS 中虽然有 $W \longrightarrow\longrightarrow S$，但这是平凡的多值依赖。WS 中已不存在非平凡的非函数依赖的多值依赖。所以 $WS \in 4NF$，同理 $WC \in 4NF$。

函数依赖和多值依赖是两种最重要的数据依赖。如果只考虑函数依赖，则属于 BCNF 的关系模式规范化程度已经是最高的了。如果考虑多值依赖，则属于 4NF 的关系模式规范化程度是最高的。事实上，数据依赖中除函数依赖和多只依赖之外，还有其他数据依赖。例如有一种连接依赖。函数依赖是多值依赖的一种特殊情况，而多值依赖实际上又是连接依赖的一种特殊情况。但连接依赖不像函数依赖和多值依赖可由语义直接导出，而是在关系的连接运算时才反映出来。存在连接依赖的关系模式仍可能遇到数据冗余及插入、修改、删除异常等问题。如果消除了属于 4NF 的关系模式中存在的连接依赖，则可以进一步达到 5NF 的关系模式。这里不再讨论连接依赖和 5NF，有兴趣的读者可以参阅有关书籍。

## 规范化小结

在关系数据库中，对关系模式的基本要求是满足第一范式。这样的关系模式就是合法的、允许的。但是，人们发现有些关系模式存在插入、删除异常，修改复杂，数据冗余等毛病。人们寻求解决这些问题的方法，这就是规范化的目的。

规范化的基本思想是逐步消除数据依赖中不合适的部分，使模式中的各关系模式大大某种程度的 “分离”，即 “一事一地” 的模式设计原则。让一个关系描述一个概念、一个实体或者实体间的一种联系。若多于一个概念就把它 “分离” 出去。因此所谓规范化实质上是概念的单一化。

人们认识这个原则是经历了一个过程的。从认识非主属性的部分函数依赖的危害开始，2NF，3NF，BCNF，4NF 的提出是这个认识过程逐步深化的标志。图 6.8 可以概括这个过程。

iamges 图 6.8 规范化过程

关系模式的规范化过程是通过对关系模式的分解来实现的。把低一级的关系模式分解为若干个高一级的关系模式。这种分解不是唯一的。下面就将进一步讨论分解后的关系模式与原关系模式 “等价“的问题以及分解的算法。