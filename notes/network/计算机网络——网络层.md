网络层主要涉及通信子网和主机的接口，网络层提供建立、维持和释放网络连接的手段，以实现两个端系统中传输实体间的通信。

网络层的功能

- 网络连接服务
- 路径选择（两个网络地址之间选择一条适当的传输路径）
- 网络连接多路复用
- 分段与组段
- 有序传输和流量控制
- 差错的检测和恢复

网络层提供的数据传输服务

- 数据报服务（收、发双方无需建立连接）
- 虚电路服务（通信双方之间建立一条虚电路进行通信）

本文主要了解网络层实际是怎样实现主机到主机的通信服务的。与传输层和应用层不同的是，在网络中的每一台主机和路由器中都有一个网络层部分。正因如此，网络层协议是协议栈中最具挑战性的部分，也是最复杂的层次之一。

# 网络层的功能

网络层是 OSI 模型中的第三层（TCP/IP模型中的网际层），提供路由和寻址的功能，使两终端系统能够互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。由于 TCP/IP 协议体系中的网络层功能由 IP 协议规定和实现，故又称 IP 层。

传输层能够为应用程序提供无连接服务或面向连接服务。以类似的方式，网络层也能够在两台主机之间提供无连接服务或连接服务。网络层的连接和无连接服务在许多方面与传输层的面向连接和无连接服务类似。例如，网络层连接服务以源和目的主机间的握手开始；网络层无连接服务则没有任何握手预备步骤。

## 虚拟互连网络

要在全世界范围内把数以百万计的网络互连起来，并且能够互联通信，是一项非常复杂的任务，此时需要解决许多问题，比如①不同的寻址方案、②不同的网络接入机制、③不同的差错处理方法、④不同的路由选择机制等等。用户的需求是多样的，**没有一种单一的网络能适应所有的需求**。网络层所要完成的任务之一就是使这些异构的网络实现互连。

所谓网络互联，是将指两个以上的计算机网络，通过一定的方法，用一种或多种通信处理设备（即中间设备）互连起来，以构成更大的网络系统。中间设备又称中间系统或中继系统。根据所在的层次，中继系统分为以下四种：

1. 物理层中继系统：转发器(repeater)。
2. 数据链路层中继系统：网桥或桥接器(bridge)。
3. 网络层中继系统：路由器(router)。
4. 网络层以上的中继系统：网关(gateway)。

使用物理层或数据链路层的中继系统时，只是把一个网络扩大了，而从网络层的角度看，它仍然是同一个网络，一般并不称之为网络互连。因此 **网络互连通常是指用路由器进行网络互联和路由选择**。路由器是一台专用计算机，用于在互联网中进行路由选择。

TCP/IP 体系在网络互连上采用的做法是在网络层（即 IP 层）采用标准化协议，但相互连接的网络可以是异构的。下图(a) 表示有许多计算机网络通过一些路由器进行互连。由于参加互连的计算机网络都使用相同的网际协议（Internet Protocol，IP），因此可以把互联后的计算机网络视为下图(b) 所示的一个虚拟互连网络。

图片

所谓虚拟互连网络也就是逻辑互连网络，即互连起来的各种物理网络的异构性本来是客观存在的，但是通过使用 IP 协议就可以使这些性能各异的网络 **在网络层上看起来好像是一个统一的网络**。这种使用 IP 协议的虚拟互连网络可简称为 IP 网。

使用 IP 网的好处是：当 IP 网上的主机进行通信时，就好像在一个单个网络上通信一样，而看不见互连的具体的网络异构细节（如具体的编址方案、路由选择协议等）。

## 路由与转发

--- 缓存 ---

网络层的作用从表面上看极其简单，即将分组从一台发送主机移动到一台接收主机。为此，需要两种重要的网络层功能：

- 转发。当一个分组到达路由器的一条输入链路时，路由器必须将分组移动到适当的输出链路。例如，来自主机 H1 到路由器 R1 的一个分组，必须向在 H2 路径上的下一台路由器转发。在下面，我们将深入路由器内部观察，考察分组在路由器中是如何实际从一条输入链路转发到一条输出链路的。
- 路由选择。当分组从发送方流向接收方时，网络层必须决定这些分组所采用的的路由或路径。计算这些路径的算法被称为路由选择算法（routing algorithm）。例如，一个路由选择算法将决定分组从 H1 到 H2 流动所遵循的路径。

转发是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。路由选择是指网络范围的过程，以决定分组从源到目的地所采取的端到端路径。

每台路由器具有一张转发表（forwarding table）。路由器通过检查到达分组首部字段的值来转发分组，然后使用该值在该路由器的转发表中索引查询。存储在转发表项中的该首部的值指出了该分组将被转发的路由器的输出链路接口。分组首部中的该值可能是该分组的目的地址或该分组所属连接的指示，这取决于网络层协议。

图

你也许现在想知道路由器中的转发表是如何配置的。这是一个关键问题，它揭示了路由选择和转发间的重要相互作用关系。如上图所示，路由选择算法决定了插入阣的转发表中的值。路由选择算法可能是集中式的，或是分布式的。在任何一种情况下，都是路由器接收路由选择协议报文，该信息被用于配置器转发表。通过考虑网络中的一种假象情况，其中所有的转发表是由人类网络操作员直接配置而在路由器中物理地存在，转发和路由选择功能的区别和不同能被进一步说明。在这种情况下，不需要任何路由选择协议！当然，该人类操作员将需要彼此交互，以确保该转发表配置得能使分组到达它们想要到达的目的地。也很可能出现下列现象；人工配置更容易出错，并且对于网络拓扑的变化，响应起来比路由选择协议慢。因此，我们庆幸所有网络具有转发和路由选择功能。

当我们讨论术语时，需要指出经常交互使用的两个其他术语，而我们将要更为小心第使用它们。我们将约定术语分组交换机是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。某些分组交换机称为链路层交换机，基于链路层字段中的值做转发决定。其他分组交换机称为路由器，基于网络层字段中的值做转发决定。市场销售资料经常将具有以太网接口的路由器称为 “三层交换机”，但它们实际上是三层设备，混淆了相关概念。因为在本章中我们关注的是网络层，所以我们使用术语路由器代替分组交换机。当我们谈论虚电路网络中的分组交换机时，我们甚至将使用词汇路由器。

**连接建立**

网络层有两个重要的功能，转发和路由选择。但我们很快将看到在某些计算机网络中，实际上有第三种重要的网络功能，即连接建立。回想我们学习 TCP 时，当数据能从发送方流向接收方之前，需要三次握手。这允许发送方和接收方建立所需的状态信息。以类似的方式，某些网络层体系结构如 ATM。帧中继、MPLS，要求从源到目的地沿着所选择的路径彼此握手，以便在给定源到目的地连接中的网络层数据分组能够开始流动之前建立起状态。在网络层，该过程被称为连接建立。

--- 缓存 ---

路由器主要完成两个功能：一是路由选择（确认哪一条路径），二是分组转发（当一个分组到达时所采取的动作）。前者是根据特定的路由选择协议构造出路由表。同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。后者处理通过路由器的数据流，关键操作时转发表查询、转发及相关的队列管理和任务调度等。

1. 路由选择。指按照复杂的分布式算法，根据从各相邻路由器所得到的的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
2. 分组转发。指路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。

路由表示根据路由选择算法得出的，而转发表示从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要对网络拓扑变化的计算最优化。在讨论路由选择的原理时，往往不去区分转发表和路由表，而是笼统地使用路由表一词。

## 数据传输服务

网络层能够在两台主机之间提供无连接服务或连接服务。与传输层面向连接和无连接服务类似，但也存在差异：

- 网络层中的服务是由网络层向传输层提供的主机到主机的服务；而传输层的服务是由传输层向应用层提供的进程到进程的服务。
- 在网络体系结构中，网络层不能同时提供无连接服务和连接服务，只能提供一种服务。
- 传输层面向连接服务是在网络边缘的端系统中实现；网络层连接服务除了在端系统外，也在位于网络核心的路由器中实现。

网络层提供的两种基本服务是虚电路网络和数据报网络。在作出转发决定时，会使用不同的信息。

### 虚电路网络

计算机网络模仿电信网所建立的面向连接的传输方式被称作 **虚电路**。

在发送数据前首先在源主机和目的主机之间建议一条虚连接。

虚电路在两个结点或应用进程之间创建起一个逻辑上的连接或虚电路后，就可以在两个节点之间依次发送每一个分组，接收端收到分组的顺序必然与发送端的发送顺序一致，因此接收端无须负责在手机分组后重新进行排序。

虚电路的组成如下：

1. 源和目的主机之间的路径。
2. VC号，沿着该路径的每段链路的一个号码。
3. 沿着该路径的每台路由器中的转发表表项。属于一条虚电路的分组将在它的首部携带一个 VC 号。

因为一条虚电路在每条链路上可能具有不同的 VC 号，每台中间路由器必须用一个新的 VC 号替代每个传输分组的 VC 号。该新的 VC 号从转发表获得。

虚电路通信过程分为三个阶段：

1. 建立连接。预留双方通信所需的一切网络资源。
2. 输出传输。双肩沿着已建立的虚电路发送分组。分组的首部不需要填写完整的目的主机地址，而只需要填写这条虚电路的编号，因而减少分组的开销。
3. 虚电路释放。在通信结束后要释放建立的虚电路。

这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组不丢失、不重复、无差错按序到达终点。

互联网是一个数据报网络，但也有很多其他网络体系结构如 ATM、帧中继等在网络层使用的连接被称为虚电路。下面考虑虚电路服务是如何实现的。



在虚电路网络中，该网络的路由器必须为进行中的连接维持连接状态信息。特别是，每当跨越一台路由器创建一个新连接，必须在该路由器的转发表中增加一个新的连接项；每当释放一个连接，必须从该表中删除该项。指的注意的是，即使没有 VC 号转换，仍有必要维持连接状态信息，该信息将 VC 号与输出接口号联系起来。路由器是否对每条进行中的连接维持连接状态信息是一个关键性问题。

在虚电路中有 3 个明显不同的阶段：

- 虚电路建立。在建立阶段，发送传输层与网络层联系，指定接收方地址，等待网络建立虚电路。
- 数据传送。一旦建立了虚电路，分组就可以开始沿该虚电路流动了。
- 虚电路拆除。当发送方或接收方通知网络层它希望终止该虚电路时，就启动这个阶段。然后网络层通常将通知网络另一侧的端系统结束呼叫，并更新路径上每台分组路由器中的转发表以表明该虚电路已不存在了。

网络层的虚电路建立与传输层的连接建立之间有一个细微但很重要的区别。传输层的连接建立仅涉及两个端系统。在传输层的连接建立期间，两个端系统独自决定传输层连接的参数。虽然这两个端系统已经知道该传输层连接，但网络中的路由器则对这些完全不知情。在另一方面，对于一个虚电路网络层，沿两个端系统之间路径上的路由器都要参与虚电路的建立，且每台路由器都完全知道经过它的所有虚电路。

端系统向网络发送指示虚电路启动与终止的报文，以及路由器之间传递的用于建立虚电路的报文，它们被称为信令报文，用于交换这些报文的协议常被称为信令协议。

### 数据报网络

在数据报网络中，每当一个端系统要发送分组，它就为该分组加上目的端系统的地址，然后将分组推进网络中。如下图所示，无需建立任何虚电路，路由器不维护任何虚电路的状态信息。

当分组从源到目的地传输，它通过一系列路由器传递。这些路由器中的每台都使用分组的目的地址来转发该分组。特别是，每台路由器有一个将目的地址映射到链路接口的转发表；当分组到达路由器时，路由器使用该分组的目的地址在转发表中查找适当的输出链路接口。然后路由器有意将分组向该输出链路接口转发。

数据报的思想非常简单：只需确保每个分组带有足够的信息，使得任何一台交换机都能决定怎样使它到达目的地。这就是说，每个分组都带有完整的目的地址。要决定怎样转发一个分组，交换机需要查阅转发表。

数据报网络有以下特点：

- 一台主机无论何时都可以发送分组，因为任何到达交换机的分组都能立即转发。正因为如此，数据报网络也称为无连接的。这和面向连接的网络不同，因为面向连接网络在发送第一个数据分组之前需要建立某种连接状态。
- 当一台主机发送一个分组时，主机无法知道网络是否可以传送该分组或目的主机是否可以接收。
- 每个分组的转发都是独立于前面的分组的，哪怕这几个分组由可能传送到相同的目的地。

### 虚电路和数据报网络的由来

数据报与虚电路网络的演化反映了它们的由来。作为一条重要的组织原则，虚电路的概念来源于电话界，它采用了真正的电路。由于呼叫建立及每呼叫的状态要在网络中的路由器上维持，一个面向虚电路的网络显然比数据报网络要复杂得多。这也与它的电话传统一致。电话网络在网络中必然有其复杂性，因为它们要了解哑端系统设备，如转盘电话。

另一方面，因特网作为一种数据报网络，是由将计算机连接在一起的需求发展而来的。由于端系统设备复杂得多，互联网架构师们选择使网络层服务模型尽可能简单。

## 拥塞控制

在通信子网中，因出现过量的分组而引起网络性能下降的现象称为拥塞。例如，某个路由器所在链路的带宽为 R B/s，如果 IP 分组只从它的某个端口进入，那么其速率为 $r_{in} \; B/s$。当 $r_{in} = R$ 时，可能看起来是件 “好事”，因为链路带宽被充分利用。但是，如下图所示，当分组到达路由器的速录接近 R 时，平均时延急剧增加，并且会有大量的分组被丢弃（路由器端口的缓冲区是有限的），整个网络的吞吐量会骤降，源与目的地之间的平均时延也会变得近乎无穷大。

判断网络是否进入拥塞状态的方法是，观察网络的吞吐量与网络负载的关系：如果随着网络负载的增加，网络的吞吐量明显小于正常的吞吐量，那么网络就可能已进入 “轻度拥塞” 状态；如果网络的吞吐量随着网络负载的增大而下降，那么网络就可能已进入拥塞状态；如果网络的负载继续增大，而网络的吞吐量下降到零，那么网络就可能已进入死锁状态。

为避免拥塞现象的出现，要采用能防止拥塞的一系列方法对子网进行拥塞控制。拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免由于拥塞而出现分组的丢失，以及严重拥塞而产生网络死锁的现象。

拥塞控制的作用是确保子网能够承载所达到的流量，这是一个全局性的过程，涉及各方面的行为：主机、路由器及路由器内部的转发处理过程等。单一地增加资源并不能解决拥塞。

**流量控制和拥塞控制的区别**：流量控制往往是指在发送端和接收端之间的点对点通信量的控制。流量控制所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。而拥塞控制必须确保通信子网能够传送待传送的数据，是一个全局性的问题，涉及网络中所有的主机、路由器及导致网络传输能力下降的所有因素。

拥塞控制的方法有两种：

1. 开环控制。在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。这是一种静态的预防方法。一旦整个系统启动并运行，中途就不再需要修改。开环控制手段包括确定何时可接收新流量、何时可丢弃分组及丢弃哪些分组，确定何种调度决策等。所有这些手段的共性是，在做决定时不考虑当前网络的状态。
2. 闭环控制。事先不考虑有关发生拥塞的各种因素，采用检测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。闭环控制是基于反馈环路的概念，是一种动态的方法。


# 路由算法

## 静态路由与动态路由

路由器转发分组是通过路由表转发的，而路由表示通过各种算法得到的。从能否随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可分为如下两大类。

静态路由算法（又称非自适应路由算法）。指由网络管理员手工配置的路由信息。当网络的拓扑结构或链路的状态发生变化时，网络管理员需要手工去修改路由表中相关的静态路由信息。大型和复杂的网络环境通常不宜采用静态路由。一方面，网络管理员难以全面地了解整个网络的拓扑结构；另一方面，当网络的拓扑结构和链路状态发生变化时，路由器中的静态路由信息需要大范围地调整，这一工作的难度和复杂程度非常高。

动态路由算法（又称自适应路由算法）。指路由器上的路由表项是通过相互连接的路由器之间彼此交换信息，然后按照一定的算法优化出来的，而这些路由信息会在一定时间间隙里不断更新，以适应不断变化的网络，以随时获得最优的寻路效果。

静态路由算法的优点是简便、可靠，在负荷稳定、拓扑变化不大的网络中运行效果很好，故仍广泛用于高度安全的军事系统和较小的商业网络。动态路由算法能改善网络的性能并有助于流量控制；但算法复杂，会增加网络的负担，有时因对动态变化的反应太快而引起振荡，或反应太慢而影响网络路由的一致性，因此要仔细设计动态路由算法，以发挥其优势。常用的动态路由算法可分为两类：距离-向量路由想法和链路状态路由算法。

## 距离-向量路由算法

在距离-向量路由算法中，所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点。这种路由选择表包含：

- 每条路径的目的地（另一结点）。
- 路径的代价（也称距离）。

注意：这里的距离是一个抽象的概念，如 RIP 就将距离定义为 “跳数”。跳数指从源端口到达目的端口所经过的路由个数，每经过一个路由器，跳数加 1。

在这种算法中，所有结点都必须参加与距离向量交换，以保证路由的有效性和一致性，也就是说，所有的结点都监听从其他结点传来的路由选择更新信息，并在下列情况下更新它们的路由选择表：

1. 被通告一条心的路由，该路由在本结点的路由表中不存在，此时本地系统加入这条心的路由。
2. 发来的路由信息中有一条到达某个目的地的路由，该路由与当前使用的路由相比，有较短的距离（较小的代价）。此种情况下，就用经过发送路由信息的结点的新路由替换路由表中到达那个目的地的现有路由。

距离-向量路由算法的实质是，迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短（最小代价）通路。它要求每个结点在每次更新时都将它的全部路由表发送给所有相邻的结点。显然，更细报文的大小与通信子网的结点个数成正比，大的通信子网将导致很大的更新报文。由于更新报文发送给直接邻接的结点，所以所有结点都将参加路由选择信息交换。基于这些原因，在通信子网上传送的路由选择信息的数量很容易变得非常大。

最常见的距离-向量路由算法是 RIP 算法，它采用 “跳数” 作为距离的度量。

## 链路状态路由算法

链路状态路由算法要求每个参与该算法的结点都具有完全的网络拓扑信息，它们执行下述两项任务。第一，主动测试所有邻接结点的状态。两个共享一条链接的结点是相邻结点，它们链接到同一条链路，或者链接到同一广播型物理网络。第二，定期地将链路状态传播给所有其他结点（或称路由结点）。典型的链路状态算法是 OSPF 算法。

在一个链路状态路由选择中，一个结点检查所有直接链路的状态，并将所得的状态信息发送给网上的所有其他结点，而不是仅送给那些直接相连的结点。每个结点都用这种方式从网上所有其他的结点接收包含直接链路状态的路由选择信息。

每当链路状态报文到达时，路由结点便使用这些状态信息去更新自己的网络拓扑和状态 “视野图”，一旦链路状态发生变化，结点就对更新的网络图利用 Dijsktra 最短路径算法重新计算路由，从单一的源出发计算到达所有目的结点的最短路径。

链路状态路由算法主要有三个特征：

1. 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法，即路由器通过所有端口向所有相邻的路由器发送信息。而每个相邻路由器又将此信息发往其所有相邻路由器（但不再发送给刚刚发来信息的那个路由器）。
2. 发送的信息是与路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓 “链路状态”，是指说明本路由器与哪些路由器相邻及该链路的 “度量”。对于 OSPF 算法，链路状态的 “度量” 主要用来表示费用、距离、时延、带宽等。
3. 只有当链路状态发生变化时，路由器才向所有路由器发送此消息。

由于一个路由器的链路状态只涉及相邻路由器的连通状态，而与整个互联网的规模并无直接关系，因此链路状态路由算法可以用于大型的或路由信息变化聚敛的互联网环境。

链路状态路由算法的主要优点是，每个路由结点都是用同样的原始状态数据独立地计算路径，而不依赖中间结点的计算：链路状态报文不加改变地传播，故采用该算法易于查找故障。当一个结点从所有其他结点接收到报文时，它可以在本地立即计算正确的通路，保证一步汇聚。最后，由于链路状态算法比距离-向量算法有更好的规模可伸展性。

**距离-向量路由算法与链路状态算法的比较**：在距离-向量路由算法汇总，每个结点仅与它的直接邻居交谈，它为它的邻居提供从自己到网络中所有其他结点的最低费用估计。在链路状态路由算法中，每个结点通过广播的方式与所有其他结点交谈，但它仅告诉它们与它直接相连的链路的费用。相比之下，距离-向量路由算法有可能遇到路由环路等问题。

## 层次路由

当网络规模扩大时，路由器的路由表成比例低增大。这不仅会消耗越来越多的路由器缓冲区空间，而且需要用更多 CPU 时间来扫描路由表，用更多的带宽来交换路由状态信息。因此路由选择必须按照层次的方式进行。

因特网将整个互联网划分为许多较小的自治系统（注意一个自治系统中包含很多局域网），每个自治系统有权自主地决定本系统内应采用何种路由选择协议。如果两个自治系统需要通信，那么就需要一种在两个自治系统之间的协议来屏蔽这些差异。据此，因特网把路由选择协议划分为两大类：

1. 一个自治系统内部所使用的路由选择协议称为内部网关协议（IGP），也称域内路由选择，具体的协议由 RIP 和 OSPF 等。
2. 自治系统之间所使用的路由选择协议称为外部网关协议（EGP），也称域间路由选择，用在不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径。具体的协议由 BGP。

使用层次路由时，OSPF 将一个自治系统再划分为若干区域（Area），每个路由器都知道在本区域内如何将分组路由到目的地的细节，但不用知道其他区域的内部结构。

采用分层次划分区域的方法虽然会使交换信息的种类增多，但也会使 OSPF 协议更加复杂。但这样做却能使每个区域内部交换路由信息的通信量大大减小，因而使 OSPF 协议能够用于规模很大的自治系统中。

# IPv4

## IPv4 分组

IPv4 即现在普遍使用的 IP（版本 4）。IP 定义数据传输的基本单元 —— IP 分组及其确切的数据格式。IP 也包括一套规则，指明分组如何处理、错误怎样控制。特别是 IP 还包含非可靠投递的思想，以及与此关联的分组路由选择的思想。

**1. IPv4 分组的格式**

一个 IP 分组由首部和数据两部分组成。首部前一部分的长度固定，供 20B，是所有 IP 分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。IP 数据报的格式如下图所示。

IP 首部的部分重要字段含义如下：

1. 版本。指 IP的版本，目前广泛使用的版本号为 4。
2. 首部长度。占 4 位。以 32 位为单位，最大值为 60B（15×4B）。最常用的首部长度是 20B，此时不使用任何选项（即可选字段）。
3. 总长度。占 16 位。指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 $2^{16} -1 = 65535B$。以太网帧的最大传送单元（MTU）为1500B，因此当一个 IP 数据报封装成帧时，数据报的总长度（首部加数据）一定不能超过下面数据链路层的 MTU 值。
4. 标识。占 16 位。它是一个计数器，没产生一个数据报就加 1，并赋值给标识字段。但它并不是 “序号”（因为 IP 是无连接服务）。当一个数据报的长度超过网络的 MTU 时，必须分片，此时每个数据报片都复制一次标识号，以便能正确重装成原来的数据报。
5. 标志。占 3 位。标志字段的最低位为 MF，MF = 1 表示后面还有分片，MF = 0 表示最后一个分片。标志字段中的一位是 DF，只有当 DF = 0 时才允许分片。
6. 片偏移。占 13 位。它指出较长的分组在分片后，某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位，即每个分片的长度一定是 8B（64位）的整数倍。
7. 首部校验和。占 16 位。IP 数据报的首部校验和只校验分组的首部，而不校验数据部分。
8. 生存时间（TTL）。占 8 位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。路由器在转发分组前，先把 TTL 减 1。若 TTL 被减为 0，则该分组必须丢弃。
9. 协议。占 8 位。指出此分组携带的数据使用何种协议，即分组的数据部分应交给哪个传输协议，如 TCP、UDP 等。其中值为 6 表示 TCP，值为 17 表示 UDP。
10. 源地址字段。占 4B，标识接收方的 IP 地址。
11. 目的地址字段。占 4B，标识发送方的 IP 地址。

注意：在 IP 数据报首部中有三个关于长度的标记，一个是首部长度、一个是总长度、一个是片偏移，基本单位分别为 4B、1B、8B（这个一定要记住）。题目中经常会出现几个长度之间的加减运算。另外，读者要熟悉 IP 数据报首部的各个字段的意义和功能，但不需要记忆 IP 数据报的首部，正常情况下如果需要参考首部，题目都会直接给出。第 5 章学到的 TCP、UDP 的首部也是一样的。

**2. IP 数据报分片**

一个链路层数据报能承载的最大数据量称为最大传送单元（MTU）。因为 IP 数据报被封装在链路层数据报中，故链路层的 MTU 严格地限制着 IP 数据报的长度，而且在 IP 数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的 MTU。例如，以太网的 MTU 为 1500B，而许多广域网的 MTU 不超过 576B。当 IP 数据报的总长度大于链路 MTU 时，就需要将 IP 数据报中的数据分装在两个或多个较小的 IP 数据报中，这些较小的数据报称为片。

片在目的地的网络层被重装组装。目的主机使用 IP 首部中的标识、标志和片偏移字段来完成对片的重组。创建一个 IP 数据报时，源主机为该数据报加上一个标识号。当一个路由器需要将一个数据报分片时，形成的每个数据报（即片）都具有原始数据报的标识号。当目的主机收到来自同一发送主机的一批数据报时，它可以通过检查数据报的标识号来确定哪些数据报属于同一个原始数据报的片。IP 首部中的标志位有 3 比特，但只有后 2 比特有意义，分别是 MF 位（More Fragment）和 DF 位（Don't Fragment）。只有当 DF = 0 时，该 IP 数据报才可以被分片。MF 则用来告知目的主机该 IP 数据报是否为原始数据报的最后一个片。当 MF = 1 时，表示相应的原始数据报还有后续的片；当 MF = 0 时，表示该数据报是相应原始数据报的最后一个片。目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始 IP 数据报的哪个位置。

IP 分片涉及一定的计算。例如，一个长 4000B 的 IP 数据报（首部 20B，数据部分 3980B）到达一个路由器，需要转发到一条 MTU 为 1500B 的链路上。这意味着原始数据报中的 3980B 数据必须被分配到 3 个独立的片中（每片也是一个 IP 数据报）。假定原始数据报的标识号为 777，那么分成的 3 片如下图所示。可以看出，由于偏移值的单位是 8B，所以除最后一个片外，其他所有片中的有效数据载荷都是 8 的倍数。

**3. 网络层转发分组的流程**

网络层的路由器质性的分组转发算法如下：

1. 从数据报的首部提取目的主机的 IP 地址 D，得出目的网络地址 N。
2. 若网络 N 与此路由器直接相连，则把数据报直接交付给目的主机 D，这称为路由器的直接交付；否则是间接交付，质性步骤3。
3. 若路由表中有目的地址为 D 的特定主机路由（对特定的目的主机指明一个特定的路由，通常是为了控制或测试网络，或出于安全考虑才采用的），则把数据报传送给路由表中所指明的下一跳路由器；否则，执行步骤4。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行步骤5。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行步骤6。
6. 报告转发分组出错。

注意：得到下一跳路由器的 IP 地址后并不是直接将该地址填入待发送的数据报，而是将该 IP 地址转换成 MAC 地址（通过ARP），将其放到 MAC 帧首部中，然后根据这个 MAC 地址找到下一跳路由器。在不同网络中传送时，MAC 帧中的源地址和目的地址要发生变化，但是网桥在转发帧时，不改变帧的源地址，请注意区分。

## IPv4 地址与 NAT

**1. IPv4 地址**

连接到因特网上的每台主机（或路由器）都分配一个 32 比特的全球唯一标识符，即 IP 地址。传统的 IP 地址是分类的地址，分为 A、B、C、D、E 五类。

无论哪类 IP 地址，都由网络号和主机号两部分组成。即 `IP 地址::={<网络号>,<主机号>}`。其中网络号标志主机（或路由器）所连接的网络。一个网络号在整个因特网范围内必须是唯一的。主机号标志该主机（或路由器）。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个 IP 地址在整个因特网范围内是唯一的。

分类的 IP 地址如下图所示。

在各类 IP 地址中，有些 IP 地址具有特殊用途，不用做主机的 IP 地址：

- 主机号全为 0 表示本网络本身，如 202.98.174.0。
- 主机号全为 1 表示本网络的广播地址，有称直接广播地址，如 202.98.174.255。
- 127.0.0.0 保留为环路自检（Loopback Test）地址，此地址表示任意主机本身，目的地址为环回地址的 IP 数据报永远不会出现在任何网络上。
- 32 位全为 0，即 0.0.0.0 表示本网络上的本主机。
- 32 位全为 1，即 255.255.255.255 表示整个 TCP/IP 网络的广播地址，又称首先广播地址。

实际使用时，由于路由器对广播域的隔离，255.255.255.255 等效为本网络的广播地址。

常用的三种类别 IP 地址的使用范围见下表。

|网络类别|最大可用网络数|第一个可用的网络号|最后一个可用的网络号|每个网络中的最大主机|
|:---:|:---:|:---:|:---:|:---:|
|A|$2^7-2$|1|126|$2^{24}-2$|
|B|$2^{14}-1$|128.1|191.255|$2^{16}-2$|
|C|$2^{21}-1$|192.0.1|223.255.255|$2^8-2$|

在上表中，A类地址可用的网络数为 $2^7-2$，减 2 的原因是：第一，网络号字段全为 0 的 IP 地址是保留地址，意思是 “本网络”；第二，网络号为 127 的 IP 地址是环回测试地址。B 类地址的可用网络数为 $2^{14}-1$，减 1 的原因是 128.0 这个网络号是不可指派的。C 类地址的可用网络数为 $2^{21}-1$，减 1 的原因是网络号为 192.0.0 的网络是不可指派的。

IP 地址有以下重要特点：

1. 每个 IP 地址都由网络号和主机号两部分组成，因此 IP 地址是一种分等地的地址结构。分等级的好处是：① IP 地址管理机构在分配 IP 地址时只分配网络号（第一级），而主机号（第二级）则由得到该网络的单位自行分配，方便了 IP 地址的管理；② 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目标主机号），从而减小了路由表所占的存储空间。
2. IP 地址是标志一台主机（或路由器）和一条链路的接口。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的 IP 地址，每个 IP 地址的网络号必须与所在网络的网络号相同，且这两个 IP 地址的网络号是不同的。因此 IP 网络上的一个路由其必然至少应具有两个 IP 地址（路由器每个端口必须至少分配一个 IP 地址）。
3. 用转发器或桥接器（网桥等）连接的若干 LAN 仍然是同一个网络（同一个广播域），因此该 LAN 中所有主机的 IP 地址的网络号必须相同，但主机号必须不同。
4. 在 IP 地址中，所有分配到网络号的网络（无论是 LAN 还是 WAN）都是平等的。
5. 在同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的。路由器总是具有两个或两个以上的 IP 地址，路由器的每个端口都有一个不同网络号的 IP 地址。

**2. 网络地址转换**

网络地址转换（NAT）是指通过将专用网络地址（如 Intranet）转换为公用地址（如 Internet），从而对外隐藏内部管理的 IP 地址。它使得整个专用网只需要一个全球 IP 地址就可以与因特网连通，由于专用网本地 IP 地址是可重用的，所以 NAT 大大节省了 IP 地址的消耗。同时，它隐藏了内部网络结果，从而降低了内部网络受到攻击的风险。

此外，为了网络安全，划出了部分 IP 地址为私有 IP 地址。私有 IP 地址只用于 LAN，不用于 WAN 连接（因此私有 IP 地址不能直接用于 Internet，必须通过网关利用 NAT 把私有 IP 地址转换为 Internet 中合法的全球 IP 地址后才能用于 Internet），并且允许私有 IP 地址被 LAN 重复使用。这有效地解决了 IP 地址不足的问题。私有 IP 地址网段如下：

- A类：1 个 A 类网段，即 10.0.0.0 ~ 10.255.255.255。
- B类：16 个 B 类网段，即 172.16.0.0 ~ 172.31.255.255。
- C类：256 个 C 类网段，即 192.168.0.0 ~ 192.168.255.255。

在因特网中的所有路由器，对目的地址是私有地址的数据报一律不进行转发。这种采用私有 IP 地址的互联网络称为专用互联网或本地互联网。私有 IP 地址也可称可重用地址。

使用 NAT 时需要在专用网连接到因特网的路由器上安装 NAT 软件，NAT 路由器至少有一个有效的外部全球地址。使用本地地址的主机和外界通信时，NAT 路由器使用 NAT 转换表将本地地址转换为全球地址，或将全球地址转换成本地地址。NAT 转换表中存放者着 `{本地 IP 地址 : 端口}` 到 `{全球 IP 地址 : 端口}` 的映射。通过 `{ip 地址 : 端口}` 这样的映射方式，就可以让多个私有 IP 地址映射到同一个全球 IP 地址。

下面以宿舍共享宽带上网为例进行说明。假设某个宿舍办理了 2Mb/s 的电信宽带，那么这个宿舍就获得了一个全球 IP 地址（如 138.76.29.7），而宿舍内 4 台主机使用私有地址（如 192.168.0.0 网段）。宿舍的网关路由器应该开启 NAT 功能，并且某时刻路由器上的 NAT 转换表见下表。那么，当路由器从 LAN 端口收到源 IP 及源端口号为 192.168.0.2:2233 的数据报时，就将其映射成 138.76.29.7:5001，然后从 WAN 端口发送到因特网上。当路由器从 WAN 端口收到目的 IP 及目的端口号为 138.76.29.7:5060 的数据报时，就将其映射成 192.168.0.3:1234，然后从 LAN 端口发送给相应的本地主机。这样，只需要一个全球地址，就可以让多态主机同时访问因特网。

注意：普通路由器在转发 IP 数据报时，不改变其源 IP 地址和目的 IP 地址。而 NAT 路由器在转发 IP 数据报时，一定要更换其 IP 地址（转换源 IP 地址或目的 IP 地址）。普通路由器仅工作在网络层，而 NAT 路由器转发数据报时需要查看和转换传输层的端口号。

## 子网划分与子网掩码、CIDR

**1. 子网划分**

两级 IP 地址的缺点：IP 地址空间的利用率有时很低；给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变坏；两级的 IP 地址不够灵活。

从 1985 年起，在 IP 地址中又增加了一个 “子网号字段”，使两级 IP 地址变成为三级 IP 地址。这种做法称为子网划分。子网划分已成为因特网的正是标准协议。

子网划分的基本思路如下：

- 子网划分纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。
- 从主机号借用若干比特作为子网号，当然主机号也就相应减少了相同的比特。三级 IP 地址的结构如下：`IP地址 = {<网络号>,<子网号>,<主机号>}`。
- 凡是从其他网络发送给本单位某台主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号，先找到连接到本单位网络上的路由器。然后该路由器在收到 IP 数据报后，按目的网络号和子网号找到目的子网。最后把 IP 数据报直接交付给目的主机。

注意：

1. 划分子网只是把 IP 地址的主机号这部分进行再划分，而不改变 IP 地址原来的网络号yinci.yinci，从一个 IP 地址本身或 IP 数据报的首部，无法判断源主机或UDID主机所连接的网络是否进行了子网划分。
2. [RFC 950] 规定，对分类的 IPv4 地址进行子网划分时，子网号不能全 1 或全 0。但随着 CIDR 的广泛使用，现在全 1 和全 0 的子网号也可使用，但一定要谨慎使用，要弄清你的路由器所用的路由选择软件是否支持全 0 或全 1 的子网号。
3. 不论是分类的 IPv4 地址还是 CIDR，其子网中的主机号为全 0 或全 1 的地址都不能被指派。子网中主机号全 0 的地址为子网的网络号，主机号全 1 的地址为子网的广播地址。

**2. 子网掩码**

为了告诉主机或路由器对一个 A 类、B 类、C 类网络进行了子网划分，使用子网掩码来表达对原网络中主机号的借位。

子网掩码是一个与 IP 地址相对应的、长 32 bit 的二进制串，它由一串 1 和跟随的一串 0 组成。其中，1 对应于 IP 地址中的网络号及子网号，而 0 对应于主机号。计算机只需将 IP 地址和其对应的子网掩码逐位 “与”（逻辑 AND 运算），就可得出相应子网的网络地址。

现在的因特网标准规定：所有的网络都必须使用子网掩码。如果一个网络未划分子网，那么就采用默认子网掩码。A、B、C 类地址的默认子网掩码分别是 255.0.0.0、255.255.0.0、255.255.255.0。例如，某主机的 IP 地址 192.168.5.56，子网掩码为 255.255.255.0，进行逐位 “与” 运算后，得出该主机所在子网的网络号为 192.168.5.0。

由于子网掩码是一个网络或一个子网的重要属性，所以路由器在相互之间交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉对方。路由表中的每个条目，除要给出目的网络地址和下一跳地址外，还要同时给出该目的网络的子网掩码。

在使用子网掩码的情况下：

1. 一台主机在设置 IP 地址信息的同时，必须设置子网掩码。
2. 同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码。
3. 路由器的路由表中，所包含信息的主要内容必须有目的网络地址、子网掩码、下一跳地址。

使用子网掩码时路由器的分组转发算法如下：

1. 从收到的分组的首部提取目的 IP 地址，记为 D。
2. 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和 D 逐位相 “与”，看结果是否和相应的网络地址匹配。若匹配，则将分组直接交付，否则就是间接交付，执行3。
3. 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给路由表中所指明的下一跳路由器；否则，执行 4。
4. 对路由表中的每一行（目的网络地址、子网掩码、下一跳地址）中的子网掩码和 D 逐位相 “与”，其结果为 N。若 N 与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则执行 5。
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行步骤 6。
6. 报告转发分组出错。

**3. 无分类域间路由选择（CIDR）**

无分类域间路由选择是在变长子网掩码的基础上提出的一种消除传统 A、B、C 类网络划分，并且可以在软件的支持下实现超网构造的一种 IP 地址的划分方法。

例如，如果一个单位需要 2000 个地址，那么就给它分配一个 2048 地址的块（8 个连续的 C 类网络），而不是一个完全的 B 类地址。这样可以大幅度提高 IP 地址空间的利用率，减小路由器的路由表大小，提高路由转发能力。CIDR 的主要特点如下：

1. 消除了传统 A、B、C 类地址及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。CIDR 使用 “网络前缀” 的概念代替子网络的概念。这样 IP 地址的无分类两级编址为：`IP::={<网络前缀>,<主机号>}`。
	CIDR 还使用 “斜线记法”（或称 CIDR 记法），即：IP地址/网络前缀所占比特数。其中，网络前缀所占比特数对应于网络号的部分，等效于子网掩码中连续 1 的部分。例如，对于 128.14.32.5/20 这个地址，它的掩码是 20 个连续的 1 和后续 12 个连续的 0，通过逐位相 “与” 的方法可以得到该地址的网络前缀（或直接截取前 20 位）：
	
	CIDR 虽然不使用子网，但仍然使用 “掩码” 一词。“CIDR 不使用子网” 是指 CIDR 并没有在 32 位地址中指明若干位作为子网字段。但分配到一个 CIDR 地址块的组织，仍可以在本组织内根据需要划分出一些子网。例如，某组织分配到地址块/20，就可以再继续划分为 8 个子网（从主机号中借用 3 位来划分子网），这时每个子网的网络前缀就变成了 23 位。全 0 和 全 1 的主机号地址一般不使用。

2. 将网络前缀都相同的连续 IP 地址组成 “CIDR 地址块”。一个 CIDR 地址块可以表示很多地址，这种地址的聚合称为路由聚合，或称构成超网。路由聚合使得路由表中的一个项目可以表示多个原来传统分类地址的路由，有利于减少路由器之间的路由选择信息的交换，从而提高网络性能。

例如，在如下图所示的网络中，如果不使用路由聚合，那么 R1 的路由表中需要分别有到网络 1 和网络 2 的路由表项。不难发现，网络 1 和网络 2 的网络前缀在二进制表示的情况下，前 16 位都是相同的，第 17 位分别是 0 和 1，并且从 R1 到网络 1 和网络 2 的路由的下一跳皆为 R2。若使用路由聚合，在 R1 看来，网络 1 和网络 2 可以构成一个更大的地址块 206.1.0.0/17，到网络 1 和网络 2 的两条路由就可以聚合成一条到 206.1.0.0/17 的路由。

CIDR 地址块中的地址数一定是 2 的整数次幂，实际可指派的地址通常为 $2^N-2$，N 表示主机号的位数，主机号全 0 代表网络号，主机号全 1 为广播地址。网络前缀越短，其地址块所包含的地址数就越多。而在三级结构的 IP 地址中，划分子网是使网络前缀变长。

CIDR 的优点在于网络前缀长度的灵活性。由于上层网络的前缀长度较短，因此相应的路由表的项目较少。而内部又可采用延长网络前缀的方法来灵活地划分子网。

最长前缀匹配（最佳匹配）：使用 CIDR 时，路由表中国的每个项目由 “网络前缀” 和 “下一跳地址” 组成。在查找路由表时可能会得到不止一个匹配结果。此时，应当从匹配结果中选择具有最长网络前缀的路由，因为网络前缀越长，其地址块就越小，因而路由就越具体。

CIDR 查找路由表的方法：为了更加有效地查找最长前缀匹配，通常将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。

## ARP、DHCP 与 ICMP

**1. IP 地址与硬件地址**

IP 地址是网络层使用的地址，它是分层次等级的。硬件地址是数据链路层使用的地址（如 MAC 地址），它是平面式的。在网络层及网络层之上使用 IP 地址，IP 地址放在 IP 数据报的首部，而 MAC 地址放在 MAC 帧的首部。通过数据封装，把 IP 数据报分组封装为 MAC 帧后，数据链路层看不见数据报分组中的 IP 地址。

由于路由器的隔离，IP 网络中无法通过广播方式依靠 MAC 地址来完成跨网站寻址，因此在 IP 网络的网络层只使用 IP 地址来完成寻址。寻址时，每个路由器依据其路由表（依靠静态路由或动态路由协议生成）选择到目标网络（即主机号全为 0 的网络地址）需要转发到下一跳（路由器的物理端口号或夏易网络地址），而 IP 分组通过多次路由转发到达目标网络后，改为在目标 LAN 中通过数据链路层的 MAC 地址以广播方式寻址。这样可以提高路由选择的效率。

1. 在 IP 层抽象的互联网上只能看到 IP 数据报。
2. 虽然在 IP 数据报首部中有完整的源 IP 地址和目标 IP 地址，但路由器只根据目的 IP 地址的网络号进行路由选择。
3. 在局域网的链路层，只能看见 MAC 帧。而通过路由器转发 IP 分组时，此 IP 分组在每个网络中都被路由器解封装和重新封装。因此 IP 数据报在被路由器转发时，其数据链路层封装所使用的 MAC 地址是不断改变的。这也决定了无法使用 MAC 地址跨网络通信。
4. 尽管互联网在一起的网络的硬件地址体系各不相同，但 IP 层抽象的互联网却屏蔽了下层这些复杂的细节。只要我们在网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机与主机或路由器之间的通信。

注意：路由器由于互联网多个网络，因此它不仅有多个 IP 地址，也有多个硬件地址。

**2. 地址解析协议（ARP）**

无论网络层使用什么协议，在实际网络的链路上传送数据帧时，最终必须使用硬件地址。所以需要一种方法来完成 IP 地址到 MAC 地址的映射，这就是地址解析协议（Address Resolution Protocol，ARP）。每台主机都设有一个 ARP 告诉缓存，用来存放本局域网上各主机和路由器的 IP 地址到 MAC 地址的映射表，称 ARP 表。使用 ARP 来动态维护此 ARP 表。

ARP 工作在网络层，其工作原理如下：主机 A 欲向本局域网上的某台主机 B 发送 IP 数据报时，先在其 ARP 告诉缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。如果没有，那么就通过使用目的 MAC 地址为 FF-FF-FF-FF-FF-FF 的帧来封装并广播 ARP 请求分组，使同一个局域网里的所有主机收到 ARP 请求。主机 B 收到该 ARP 请求后，向主机 A 发出响应 ARP 分组，分组中包含本机 B 的 IP 与 MAC 地址的映射关系，主机 A 在收到后将此映射写入 ARP 缓存，然后按查询到的硬件地址发送 MAC 帧。ARP 由于 “看到了” IP 地址，所以它工作在网络层，而 NAT路由器由于 “看到了” 端口，所以它工作在传输层。对于某个协议工作在哪个层次，读者应该能通过协议的工作原理进行猜测。

注意：ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做，尽管 ARP 请求分组是广播发送的，但 ARP 响应分组是普通的单播，即从一个源地址发送到一个目的地址。

ARP 的 4 中典型情况总结如下：

1. 发送方是主机时，要把 IP 数据报发送到本网络上的另一台主机。这时用 ARP 找到目的主机的硬件地址。
2. 发送方是主机时，要把 IP 数据报发送到另一个网络上的一台主机。这时用 ARP 找到本网络上的一个路由器的硬件地址，剩下的工作由这个路由器来完成。
3. 发送方是路由器时，要把 IP 数据报转发到本网络上的一台主机。这时用 ARP 找到目的主机的硬件地址。
4. 发送方是路由器时，要把 IP 数据报转发到另一个网络上的一台主机。这时用 ARP 找到本网络上的一个路由器的硬件地址，剩下的工作由找到的这个路由器完成。

从 IP 地址到硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程。只要主机或路由器和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 就会自动地将这个 IP 地址解析为链路层所需要的硬件地址。

**3. 动态主机配置协议（DHCP）**

动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）常用于给主机动态地分配 IP 地址，它提供了即插即用联网的机制，这种机制允许一台计算机加入新的网络和获取 IP 地址而不用手工参与。**DHCP 是应用层协议，它是基于 UDP 的**。

DHCP 的工作原理如下：使用客户/服务器方式。需要 IP 地址的主机在启动时就向 DHCP 服务器广播发送发现报文，这时该主机就成为 DHCP 客户。本地网络上所有主机都能收到此广播报文，但只有 DHCP 服务器才回答此广播报文。DHCP 服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的 IP 地址池中取出一个地址分配该计算机。DHCP 服务器的回答报文叫做提供报文。

DHCP 服务器聚合 DHCP 客户端的交换过程如下：

1. DHCP 客户机广播 “DHCP 发现” 消息，试图找到网络中的 DHCP 服务器，服务器获得一个 IP 地址。
2. DHCP 服务器收到 “DHCP 发现” 消息后，向网络中广播 “DHCP 提供” 消息，其中包括提供 DHCP 客户机的 IP 地址和相关配置信息。
3. DHCP 客户机收到 “DHCP 提供” 消息，如果接收 DHCP 服务器所提供的相关参数，那么通过广播  “DHCP 请求” 消息向 DHCP 服务器请求提供 IP 地址。
4. DHCP 服务器广播 “DHCP 确认” 消息，将 IP 地址分配给 DHCP 客户机。

DHCP 允许网络上配置多态 DHCP 服务器，当 DHCP 客户机发出 DHCP 请求时，有可能收到多个应答消息。这时，DHCP 客户机只会挑选其中一个，通常挑选最先到达的。

DHCP 服务器分配给 DHCP 客户的 IP 地址是临时的，因此 DHCP 客户只能在一段有限的时间内使用这个分配到的 IP 地址。DHCP 称这段时间为租用期。租用期的数值应由 DHCP 服务器自己决定，DHCP 客户也可在自己发送的报文中提出对租用期的要求。

DHCP 是应用层协议，因为它是通过客户/服务器方式工作的，DHCP 客户端向 DHCP 服务器请求服务。读者在后面的学习中会了解到，应用层协议由两种工作方式：客户/服务器方式和 P2P 方式，而其他层次的协议是没有这两种工作方式的。

DHCP 的客户端和服务器端需要通过广播方式来进行交互，原因是在 DHCP 执行期间，客户端和服务器端都没有标识自己身份的 IP 地址，因此不可能通过单播的形式进行交互。采用 UDP 而不采用 TCP 的原因也很明显，TCP 需要建立连接，如果连对方的 IP 地址都不知道，那么更不可能通过双方的套接字建立连接。

**4. 网际控制报文协议（ICMP）**

为了提高 IP 数据报交付成功的机会，在网络层使用了网际控制报文协议（Internet Control Message Protocol，ICMP）来让主机或路由器报告差错和异常情况。ICMP 报文作为 IP 数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。**ICMP 是 IP 层协议**。

ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文。

ICMP 差错报告报文用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况。共有以下 5 中类型：

1. 终点不可达。当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。
2. 源点抑制。当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
3. 时间超过。当路由器收到生存时间（TTL）为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
4. 参数问题。当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
5. 改变路由（重定向）。路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

不应发送 ICMP 差错报告报文的几种情况如下：

1. 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
2. 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
3. 对具有组播地址的数据报都不发送 ICMP 差错报告报文。
4. 对具有特殊地址（如 127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

ICMP 询问报文有 4 中类型：回送请求和回答报文、时间戳请求和回答报文、掩码地址请求和回答报文、路由器询问和通告报文，最常用的是前两类。

ICMP 的两个常见应用是分组网间探测 PING（用来测试两台主机之间的连通性）和 traceroute（UNIX 中的名字，在 Windows 中是 tracert，可以用来跟踪分组经过的路由）。其中 PING 使用了 ICMP 回送请求和回答报文，traceroute（Tracert）使用了 ICMP 时间超过报文。

注意：PING 工作在应用层，它直接使用网络层的 ICMP 协议，额人没有使用传输层的 TCP 或 UDP 协议。Traceroute/Tracert 工作在网络层。

# IPv6

## IPv6 的主要特点

解决 IP 地址耗尽问题的措施有以下三种：① 采用无类别编址 CIDR，使 Ip 地址的分配更加合理；② 采用网络地址转换（NAT）方法以节省全球 IP 地址；③ 采用具有更大地址空间的新版本的 IPv6。其中前两种方法只是延长了 IPv4 地址分配结束的时间，只有第三种方法从根本上解决了 IP 地址的耗尽问题。

IPv6 的主要特点如下：

1. 更大的地址空间。IPv6 将地址从 IPv4 的 32 位增大到了 128 位。IPv6 的字节数（16B）是 IPv4 字节数（4B）的平方。
2. 扩展的地址层次结构。
3. 灵活的首部格式。
4. 改进的选项。
5. 允许协议继续扩充。
6. 支持即插即用（即自动配置）。
7. 支持资源的预分配。
8. IPv6 只有在包的源结点才能分片，是端到端的，传输路径中的路由器不能分片，所以从一般意义上说，IPv6 不允许分片（不允许类似 IPv4 在路由分片）。
9. IPv6 首部长度必须是 8B 的整数倍，而 IPv4 首部是 4B 的整数倍。
10. 增大了安全性。身份验证和保密功能是 IPv6 的关键特征。

虽然 IPv6 与 IPv4 不兼容，但总体而言它与所有其他的因特网协议兼容包括 TCP、UDP、ICMP、IGMP、OSPF、BGP 和 DNS，只是在少数地方做了必要的修改（大部分是为了处理长的地址）。IPv6 相当好地满足了预定的目标，主要体现在：

1. 首先也是最重要的，IPv6 有比 IPv4 长的多的地址。IPv6 的地址用 16 个字节表示，地址空间是 IPv4 的 $2^{128-32}=2^{96}$倍，从长远来看，这些地址是绝对够用的。
2. 简化了 IP 分组头，它包含 8 个域（IPv4 是 12 个域）。这一改变使得路由器能够更快地处理分组，从而可以改善吞吐率。
3. 更好地支持选项。这一改变对新的分组首部很重要，因为一些从前必要的段现在变成了可选段。此外，表示选项的方式的改变还能加快分组的处理速度。


## IPv6 地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：

1. 单播。单播就是传统的点对点通信。
2. 多播。多播是一点对多点的通信，分组被交付到一组计算机的每一个。
3. 任播。这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一台计算机，通常是距离最近的一台计算机。

IPv4 地址通常使用点分十进制表示法。如果 IPv6 也使用这种表示法，那么地址书写起来将会相当长。在 IPv6 标准中指定了一种比较紧凑的表示法，即把地址中的每 4 位用一个十六进制数表示，并用冒号分隔每 16 位，如 4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170。

通常可以把 IPv6 地址缩写成更紧凑的形式。当 16 位域的开头由一些 0 时，可以采用一种缩写表示法，但在域中必须至少有一个数字。例如，可以把地址 4BF5:0000:0000:0000:BA5F:039A:000A:2176 缩写为 4BF5:0:0:0:BA5F:39A:A:2176。

当有相继的 0 值域时，还可以进一步缩写。这些域可以用双冒号缩写（`::`）。当然，双冒号表示法在一个地址中仅能出现一次，因为 0 值域的个数没有编码，需要从指定的总的域的个数来推算。这样一来，前述地址可被更紧凑地书写成 4BF5::BA5F:39A:A:2176。

IPv6 扩展了 IPv4 地址的分级概念，它使用以下 3 个等级：第一级（顶级）指明全球都知道的公共拓扑；第二级（场点级）指明单个场点；第三极指明单个网络接口。IPv6 地址采用多级体系主要是为了使路由器能够更快地查找路由。

IPv4 向 IPv6 过渡只能采用逐步演进的办法，同时还必须使新安装的 IPv6 系统能够向后兼容。IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。

IPv4 向 IPv6 过渡可以采用双协议栈和隧道技术两种策略：双协议栈是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）装有两个协议栈，一个 IPv4 和一个 IPv6，通过双协议栈进行转换；隧道技术是将整个 IPv6 数据报封装到 IPv4 数据报的数据部分，这样使得 IPv6 数据报可以在 IPv4 网络的隧道中传输。

# 路由协议

## 自治系统

自治系统（Autonomous System，AS）：单一技术管理下的一组路由器，这些路由器使用一种 AS 内部的路由选择协议和共同的度量来确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议来确定分组在 AS 之间的路由。

一个自治系统内的所有网络都由一个行政单位（如一家公司、一所大学、一个政府部门等）管辖，一个自治系统的所有路由器在本自治系统内都必须是连通的。

## 域内路由与域间路由

自治系统内部的路由选择称为域内路由选择，自治系统之间的路由选择称为域间路由选择。因特网有两大类路由选择协议。

**1. 内部网关协议（Interior Gateway Protocol，IGP）**

内部网关协议即在一个自治系统内部使用的路由选择协议，它与互联网中其他自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如 RIP 和 OSPF。

**2. 外部网关协议（External Gateway Protocol，EGP）**

若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时（两个自治系统可能使用不同的 IGP），就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议（EGP）。目前使用最多的外部网关协议是 BGP-4。

下图是两个自治系统互联的示意图。每个自治系统自己决定在本自治系统内部运行哪个内部路由选择协议（例如，可以是 RIP，也可以是 OSPF），但每个自治系统都有一个或多个路由器（图中的路由器 $R_1$ 和 $R_2$）。除运行本系统的内部路由选择协议外，还要运行自治系统间的路由选择协议（如 BGP-4）。

## 路由信息协议（RIP）

路由信息协议（Routing Information Protocol，RIP）是内部网关协议（IGP）中最先得到广泛应用的协议。RIP 是一种分布式的基于距离向量的路由选择协议，其最大优点就是简单。

**1. RIP 规定**

1. 网络中的每个路由器都要维护从它自身到其他每个目的网络的距离记录（因此这是一组距离，称为距离向量）。
2. 距离也称跳数（Hop Count），规定从一个路由器到直接连接网络的距离（跳数）为1。而每经过一个路由器，距离（跳数）加 1。
3. RIP 认为好的路由就是它通过的路由器的数目少，即优先选择跳数少的路径。
4. RIP 允许一条路径最多只能包含 15 个路由器（即最多允许 15 跳）。因此距离等于 16 时，它表示网络不可达。可见 RIP 只适用于小型互联网。距离向量路由可能会出现环路的情况，规定路径上的最高跳数的目的是为了防止数据报不断循环在环路上，减少网络拥塞的可能性。
5. RIP 默认在任意两个使用 RIP 的路由器之间每 30 秒广播一次 RIP 路由更新信息以便自动建立并维护路由表（动态维护）。
6. 在 RIP 中不支持子网掩码的 RIP 广播，所以 RIP 中每个网络的子网掩码必须相同。但在新的 RIP2 中，支持变长子网掩码和 CIDR。

**2. RIP 的特点（注意与 OSPF 的特点比较）**

1. 仅和相邻路由器交换信息。
2. 路由器交换的信息是当前路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息，如每隔 30 秒。

RIP 通过距离向量算法来完成路由表的更新。最初，每个路由器只知道与自己直接相连的网络。通过每 30 秒的 RIP 广播，相邻两个路由器相互将自己的路由表发给对方。于是经过第一次 RIP 广播，每个路由器就知道了与自己相邻的路由器的路由表（即知道了距离自己的跳数为 1 的网络的路由）。同理，经过第二次 RIP 广播，每个路由器就知道了距离自己跳数为 2 的网络的路由······因此经过若干 RIP 广播后，所有路由器都最终知道了整个 IP 网络的路由表，成为 RIP 最终是收敛的。通过 RIP 收敛后，每个路由器到每个目标网络的路由都是距离最短的（即跳数最少，最短路由），哪怕还存在另一条高速（低时延）但路由器较多的路由。

**3. 距离向量算法**

每个路由表项目都有三个关键数据：`<目的网络 N, 距离 d, 下一条路由器 X>`。对于每个相邻路由器发送过来的 RIP 报文，执行如下步骤：

1. 对地址为 X 的相邻路由器发来的 RIP 报文，先修改此报文中的所有项目：把 “下一跳” 字段中的地址都改为 X，并把所有 “距离” 字段的值加 1。
2. 对修改后的 RIP 报文中的每个项目，执行如下步骤：
	- ① 当原来的路由表总没有目的网络 N 时，把该项目添加到路由表中。
	- ② 当原来的路由表中有目的网络 N，且下一跳路由器的地址是 X 时，用收到的项目替换原路由表中的项目。
	- ③ 当原来的路由表中有目的网络 N，且下一跳路由器的地址不是 X 时，如果收到的项目中的距离 d 小于路由表中的距离，那么就用收到的项目替换原路由表中的项目，否则什么也不做。

3. 如果 180 秒（RIP 默认超时时间为 180 秒）还没有收到相邻路由器的更新	路由表，那么把此相邻路由器记为不可达路由器，即把距离设置为 16（距离为 16 表示不可达）。
4. 返回。

RIP 最大的优点是实现简单、开销小、收敛过程较快。RIP 的缺点如下：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大。
3. 网络出现故障时，会出现慢收敛现象（即需要较长时间才能将此信息传送到所有路由器），俗称 “坏消息传的慢”，使更新过程的收敛时间长。

RIP 是应用层协议，它使用 UDP 传送数据（端口 520）。RIP 选择的路径不一定是时间最短的，但一定是具有最少路由器的路径。因为它是根据最少的跳数进行路径选择的。

## 开放最短路径优先（OSPF）协议

**1. OSPF 协议的基本特点**

开放最短路径优先（OSPF）协议是使用分布式链路状态路由算法的典型代表，也是内部网关协议（IGP）的一种。OSPF 与 RIP 相比有以下 4 点主要区别：

1. OSPF 向本自治系统中的所有路由器发送信息，这里使用的方法是洪泛法。而 RIP 仅向自己相邻的几个路由器发送信息。
2. 发送的信息是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。“链路状态” 说明本路由器和哪些路由器相邻及该链路的 “度量”（或代价）。而在 RIP 中，发送的信息是本路由器所知道的全部信息，即整个路由表。
3. 只有当链路状态发送变化时，路由表才用洪泛法向所有路由器发送此信息，并且更新过程收敛得快，不会出现 RIP “坏消息传得慢” 的问题。而在 RIP 中，不管网络拓扑是否发生变化，路由器之间都会定期交换路由表的信息。
4. OSPF 是网络层协议，它不使用 UDP 或 TCP，而直接用 IP 数据报传送（其 IP 数据报首部的协议字段为 89）。而 RIP 是应用层协议，它在传输层使用 UDP。

除以上区别外，OSPF 还有以下特点：

1. OSPF 对不同的链路可根据 IP 分组的不同服务类型（TOS）而设置成不同的代价。因此，OSPF 对于不同类型的业务可计算出不同的路由，十分灵活。
2. 如果到同一个目的网络由多条相同代价的路径，那么可以将通信量分配给这几条路径。这称为多路径间的负载平衡。
3. 所有在 OSPF 路由器之间交换的分组都具有鉴别功能，因而保证了仅在可信赖的路由器之间交换链路状态信息。
4. 支持可变长度的子网划分和无分类编址 CIDR。
5. 每个链路状态都带上一个 32 位的序号，序号越大，状态就越新。

**2. OSPF 的基本工作原理**

由于各路由器之间频繁地交换链路状态信息，因此所有路由器最终都能建立一个链路状态数据库。这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（称为链路状态数据库的同步）。然后，每个路由器根据这个全网拓扑结构图，使用 Dijkstra 最短路径算法计算从自己到各目的网络的最优路径，以此构造自己的路由表。此后，当链路状态发送变化时，每个路由器重新计算到各自的网络的最优路径，构造新的路由表。

注意：虽然使用 Dijkstra 算法能计算出完整的最优路径，但路由表中不会存储完整路径，而只存储 “下一跳”（只有到了下一跳路由器，才能知道再下一跳应当怎样走）。

为使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干更小的范围，称为区域。划分区域的好处是，将利用洪泛法交换链路状态信息的范围局限于每个区域而非整个自治系统，减少了整个网络上的通信量。在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑情况。这些区域也有层次之分。处在上层的域称为主干区域，负责连通其他下层的区域，并且还连接其他自治域。

**3. OSPF 的五种分组类型**

OSPF 共有以下五种分组类型：

1. 问候分组，用来发现和维持邻站的可达性。
2. 数据库描述分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
3. 链路状态请求分组，向对方请求发送某些链路状态项目的详细信息。
4. 链路状态更新分组，用洪泛法对全网更新链路状态。
5. 链路状态确认分组，对链路更新分组的确认。

通常每隔 10 秒，每两个相邻路由器要交换一次问候分组，以便知道哪些站可达。在路由器刚开始工作时，OSPF 让每个路由器使用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息。然后，路由器使用链路状态请求分组，向对方请求发送自己所缺少的某些链路状态项目的详细信息。经过一系列的这种分组交换，就建立了全网同步的链路数据库。下图给出了 OSPF 的基本操作，说明了两个路由器需要交换的各种类型的分组。

在网络运行的过程中，只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态。其他路由器在更新后，发送链路状态确认分组对更新分组进行确认。

为了确保链路状态数据库与全网的状态保持一致，OSPF 还规定每隔一段时间（如 30 分钟）就刷新一次数据库中的链路状态。由于一个路由器的链路状态只涉及与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此，当互联网规模很大时，OSPF 要比 RIP 好得多，而且 OSPF 协议没有 “坏消息传播得慢” 的问题。

注意：上面说的 OSPF 协议不使用 UDP 数据报传送，而是直接使用 IP 数据报传送在此解释一下什么称为用 UDP 传送，什么称为用 IP 数据报传送。用 UDP 传送是指将该信息作为 UDP 报文上的数据部分，而直接使用 IP 数据报传送是指将垓心直接作为 IP 数据报的数据部分。RIP 报文是作为 UDP 数据报的数据部分。

## 边界网关协议（BGP）

边界网关协议（Border Gateway Protocol，BGP）是不同自治系统的路由器之间交换路由信息的协议，是一种外部网关协议。边界网关协议常用于互联网的网关之间。路由表包含已知路由器的列表、路由器能够达到的地址及到达每个路由器的路径的跳数。

内部网关协议主要设法使数据报在一个 AS 中尽可能有效地从源站传送到目的站。在一个 AS 内部不需要考虑其他方面的策略。然而 BGP 使用的环境却不同，主要原因如下：

1. 因特网的规模太大，使得自治系统之间路由选择非常困难。
2. 对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
3. 自治系统之间的路由选择必须考虑有关策略。

边界网关协议（BGP）只能力求寻找一条能够达到目的网络且比较好的路由（不能兜圈子），而并非寻找一条最佳路由。BGP 采用的是路径向量路由选择协议，它与距离向量协议和链路状态协议由很大的区别。BGP 是应用层协议，它是基于 TCP 的。

BGP 的工作原理如下：每个自治系统的管理员要选择至少一个路由器（可以有多个）作为该自治系统的 “BGP 发言人”。一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接（可见 BGP 报文是通过 TCP 传送的，也就是说 BGP 报文的 TCP 报文的数据部分），然后在此连接上交换 BGP 报文以建立 BGP 会话，再利用 BGP 会话交换路由信息。当所有 BGP 发言人都相互交换网络可达性的信息后，各 BGP 发言人就可找出到达各个自治系统的较好路由。

每个 BGP 发言人除必须运行 BGP 外，还必须运行该 AS 所用的内部网关协议，如 OSPF 或 RIP。BGP 所交换的网络可达性信息就是要到达某个网络（用网络前缀表示）所要经过一系列 AS。下图给出了一个 BGP 发言人交换路径向量的例子。

BGP 的特点如下：

1. BGP 交换路由信息的结点数量级是自治系统的数量级，要比这些自治系统中的网络数少很多。
2. 每个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。
3. BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由表，以及到达该目的网络所要经过的各个自治系统序列。
4. 在 BGP 刚运行时，BGP 的邻站交换整个 BGP 路由表，但以后只需在发生变化时更新有变化的部分。这样做对节省网络带宽和较少路由器的处理开销都有好处。

BGP-4 共使用 4 种报文：

1. 打开（Open）报文。用来与相邻的另一个 BGP 发言人建立关系。
2. 更新（Update）报文。用来发送某一路由的信息，以及列出要撤销的多条路由。
3. 保活（Keepalive）报文。用来确认打开报文并周期性地证实邻站关系。
4. 通知（Notification）报文。用来发送检测到的差错。

RIP、OSPF 与 BGP 的比较如下表所示。

<escape>
    <table class="table table-bordered table-striped table-condensed">
        <tr>
            <td>协议</td>
            <td>RIP</td>
            <td>OSPF</td>
            <td colspan="2">BGP</td>
        </tr>
        <tr>
            <td>类型</td>
            <td>内部</td>
            <td>内部</td>
            <td colspan="2">外部</td>
        </tr>
        <tr>
            <td>路由算法</td>
            <td>距离-向量</td>
            <td>链路状态</td>
            <td colspan="2">路径-向量</td>
        </tr>
        <tr>
            <td>传递协议</td>
            <td>UDP</td>
            <td>IP</td>
            <td colspan="2">TCP</td>
        </tr>
        <tr>
            <td>路径选择</td>
            <td>跳数最少</td>
            <td>代价最低</td>
            <td colspan="2">较好，非最佳</td>
        </tr>
        <tr>
            <td>交换结点</td>
            <td>和本结点相邻的路由器</td>
            <td>网络中的所有路由器</td>
            <td colspan="2">和本结点相邻的路由器</td>
        </tr>
        <tr>
            <td rowspan="2">交换内容</td>
            <td rowspan="2">当前本路由器知道的全部信息，即自己的路由表</td>
            <td rowspan="2">与本路由器相邻的所有路由器的链路状态</td>
            <td>首次</td>
            <td>整个路由表</td>
        </tr>
        <tr>
            <td>非首次</td>
            <td>有变化的部分</td>
        </tr>
    </table>
</escape>


# IP 组播

## 组播的概念

为了能够支持像视频点播和视频会议这样的多媒体应用，网络必须实施某种有效的组播机制。使用多个单播传送来仿真组播总是可能的，但这会引起主机上大量的处理开销和网络上太多的交通量。人们所需要的组播机制是让源计算机一次发送的单个分组可以抵达用一个组地址标识的若干目标主机，并被它们正确接收。

组播一定仅应用于 UDP，它对将报文同时送往多个接收者的应用来说非常重要。而 TCP 是一个面向连接的协议，它意味着分别运行于两台主机（由 IP 地址来确定）内的两个进程（由端口号来确定）之间存在一条连接，因此会一对一发送。

使用组播的缘由是，有的应用程序要把一个分组发送给多个目的地主机。不是让源主机给每个目的地主机都发送一个单独的分组，而是让源主机把单个分组发送给一个组播地址，该组播地址标识一组地址。网络（如因特网）把这个分组的副本投递给该组中的每台主机。主机可以选择加入或离开一个组，因此一台主机可以同时属于多个组。

因特网中的 IP 组播也使用组播组的概念，每个组都有一个特别分配的地址，要给该组发送的计算机将使用这个地址作为分组的目标地址。在 IPv4 中，这些地址在 D 类地址空间中分配，而 IPv6 也有一部分地址空间保留给组播组。

主机使用一个称为 IGMP（因特网组管理协议）的协议加入组播组。它们使用该协议通知本地网络上的路由器关于要接收发送给某个组播组的分组的愿望。通过扩展路由器的路由选择和转发功能，可以在许多路由器互联的支持硬件组播的网络上面实现因特网组播。

需要注意的是，主机组播时仅发送一份数据，只有数据在传送路径出现分岔时才将分组复制后继续转发。因此，对发送者而言，数据只需发送一次就可发送到所有接收者，大大减轻了网络的负载和发送者的负担。组播需要路由器的支持才能实现，能够运行组播协议的路由器称为 **组播路由器**。单播与组播的比较如下图所示。

## IP 组播地址

IP 组播使用 D 类地址格式。D 类地址的前四位是 1110，因此 D 类地址范围是 224.0.0.0~239.255.255.255。每个 D 类 IP 地址标志一个组播组。

组播数据报和一般的 IP 数据报的区别是，前者使用 D 类 IP 地址作为目的地址，并且首部中的协议字段值是 2，表明使用 IGMP。需要注意的是：

1. 组播数据报也是 “尽最大努力交付”，不提供可靠交付。
2. 组播地址只能用于目的地址，而不能用于源地址。
3. 对组播数据报不产生 ICMP 差错报文。因此，若在 PING 命令后面键入组播地址，将永远不会收到响应。
4. 并非所有的 D 类地址都可作为组播地址。

IP 组播可以分为两种：一种只在本局域网上进行硬件组播；另一种则在因特网的范围内进行组播。在因特网上进行组播的最后阶段，还是要把组播数据报在局域网上用硬件组播交付给组播组的所有成员[见上图(b)]。下面讨论这种硬件组播。

例如，IP 组播地址 224.128.64.32（即 E0-80-40-20）和另一个 IP 组播地址 224。0.64.32（即 E0-00-40-20）转换成以太网的硬件组播地址都是 01-00-5E-00-40-20。由于组播 IP 地址与以太网硬件地址的映射关系不是唯一的，因此受到组播数据报的主机，还要在 IP 层利用软件进行过滤，把不是本主机要接收的数据报丢弃。

## IGMP 与组播路由算法

要使路由器知道组播组成员的信息，需要利用因特网组管协议（Internet Group Management Protocol，IGMP）。连接到局域网上的组播路由器还必须和因特网上的其他组播路由器协同工作，以便把组播数据报用最小代价传送给所有组成员，这就需要使用组播路由选择协议。

IGMP 并不是在因特网范围内对所有组播组成员进行管理的协议。IGMP 不知道 IP 组播组包含的成员数，也不知道这些成员分布在哪些网络上。IGMP 让连接到本地局域网上的组播路由器知道本局域网上是否有主机参加或退出了某个组播组。

IGMP 应视为 TCP/IP 的一部分，其工作可分为两个阶段。

第一阶段：当某台主机加入新的组播组时，该主机应向组播组的组播地址发送一个 IGMP 报文，声明自己要成为该组的成员。本地的组播路由器收到 IGMP 报文后，将组成员关系转发给因特网上的其他组播路由器。

第二阶段：因为组成员关系是动态的，本地组播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否仍继续是组的成员。只要对某个组有一台主机响应，那么组播路由器就认为这个组是活跃的。但一个组在经过几次的探询后仍然没有一台主机响应时，则不再将该组的成员关系转发给其他的组播路由器。

组播路由选择实际上就是要找出以源主机为根结点的组播转发树，其中每个分组在每条链路上只传送一次（即在组播转发树上的路由器不会收到重复的组播数据报）。不同的多播组对应于不同的多播转发树；同一个多播组，对不同的源点也会有不同的多播转发树。

在许多由路由器互联的支持硬件多点传送的网络上实现因特网组播时，主要有三种路由算法：第一种是基于链路状态的路由选择；第二种是基于距离-向量的路由选择；第三种可以建立在任何路由器协议之上，因此称为协议无关的组播（PIM）。

# 移动 IP

## 移动 IP 的概念

支持移动性的因特网体系结构与协议共称为移动 IP，它是为了满足移动结点（计算机、服务器、网段等）在移动中保持其连接性而技术的。更确切说，移动 IP 技术是指移动结点以固定的网络 IP 地址实现跨越不同网段的漫游功能，并保证基于网络 IP 的网络权限在漫游过程中不发生任何改变。移动 IP 的目标是把分组自动地投递给移动结点。一个移动结点是把其连接点从一个网络或子网改变到另一个网络或子网的主机。使用移动 IP，一个移动结点可以在不改变其 IP 地址的情况下改变其驻留位置。

基于 IPv4 的移动 IP 定义三种功能实体：移动结点、归属代理（也称本地代理）和外埠代理（也称外部代理）。归属代理和外埠代理又统称为移动代理。

1. 移动结点。具有永久 IP 地址的移动结点。
2. 本地代理。在一个网络环境中，一个移动结点的永久 “居所” 被称为归属网络，在归属网络中代表移动结点执行移动管理功能的实体称为归属代理（本地代理），它根据移动用户的转交地址，采用隧道技术转交移动结点的数据包。
3. 外部代理。在外部网络中帮助移动结点完成移动管理功能的实体称为外部代理。

移动 IP 和移动自组网络并不相同，移动 IP 技术使漫游的主机可以用多种方式连接到因特网，移动 IP 的核心网络功能仍然是基于固定互联网中一直使用的各种路由选择协议，移动自组网络是将移动性扩展到无线领域中的自治系统，它具有自己独特的路由选择协议，并且可以不和因特网相连。

移动 IP 与动态 IP 是两个完全不同的概念，动态 IP 指的是局域网中的计算机可以通过网络中的 DHCP 服务器动态地获得一个 IP 地址，而不需要用户在计算机的网络设置中指定 IP 地址，动态 IP 和 DHCP 经常会应用在我们的实际工作环境中。

## 移动 IP 通信过程

在移动 IP 中，每个移动结点都有一个唯一的本地地址，当移动结点移动时，它的本地地址是不变的，在本地网络链路上每个本地结点还必须有一个本地代理来为它维护当前的位置信息，这就需要引入转交地址。当移动结点连接到外地网络链路上时，转交地址就用来标识移动结点现在所处的位置，以便进行路由选择。移动结点的本地地址与当前转交地址的联合称为移动绑定或简称绑定。当移动结点得到一个新的转交地址时，通过绑定向本地代理进行注册，以便让本地代理即使了解移动结点的当前位置。

移动 IP 技术的基本通信流程如下：

1. 移动结点在本地网络时，按传统的 TCP/IP 方式进行通信（在本地网络有固定的地址）。
2. 移动结点漫游到一个外地网络时，仍然使用固定的 IP 地址进行通信。为了能够收到通信对端发给它的 IP 分组，移动结点需要向本地代理注册当前的位置地址，这个位置地址就是转交地址（它可以是外部代理的地址或动态配置的一个地址）。
3. 本地代理接收来自转交地址的注册后，会构建一条通向转交地址的隧道，将截获的发给移动结点的 IP 分组通过隧道送到转交地址处。
4. 在转交地址处解除隧道封装，恢复原始的 IP 分组，最后送到移动结点，这样移动结点在外网就能够收到这些发送给它的 IP 分组。
5. 移动结点在外网通过外网的路由器或外部代理向通信对端发送 IP 数据包。
6. 移动结点来到另一个外网时，只需向本地代理更新注册的转交地址，就可继续通信。
7. 移动结点回到本地网时，移动结点向本地代理注销转交地址，这时移动结点又将使用传统的 TCP/IP 方式进行通信。

移动 IP 为移动主机设置了两个 IP 地址，即主地址和辅地址（转交地址）。移动主机在本地网时，使用的是主地址。当移动到另一个网络时，需要获得一个临时的辅地址，但此时主地址仍然不变。从外网移回本地网时，辅地址改变或撤销，而主地址仍然保持不变。

# 网络层设备

## 路由器的组成和功能

路由器是一种具有多个输入/输出端口的专用计算机，其任务是连接不同的网络（连接异构网络）并完成路由转发。在多个逻辑网络（即多个广播域）互联时必须使用路由器。路由器也可以作为最基础的包过滤防火墙应用。

当源主机要想目标主机发送数据报时，路由器先检查源主机与目标主机是否连接在同一个网络上。如果源主机和目标主机在同一个网络上，那么直接交付而无须通过路由器。如果源主机和目标主机不在同一个网络上，那么路由器按照转发表（路由表）指出的路由将数据报转发给下一个路由器，这称为间接交付。可见，在同一个网络中传递数据无须路由器的参与，而跨网络通信必须通过路由器进行转发。例如，路由器可以连接不同的 LAN，连接不同的 VLAN，连接不同的 WAN，或者把 LAN 和 WAN 互联起来。路由器隔离了广播域。

从结构上看，路由器由路由选择和分组转发两部分构成，如下图所示。而从模型的角度看，路由器是网络层设备，它实现了网络模型的下三层，即物理层、数据链路层和网络层。

注意，如果一个存储转发设备实现了某个层次的功能，那么它就可以互联在该层次上使用不同协议的网段（网络）。如果网桥实现了物理层和数据链路层，那么网桥可以互联两个物理层和数据链路层不同的网段；但中继器实现了物理层后，却不能互联两个物理层不同的网段，这是因为中继器不是存储转发设备，它属于直通式设备。

路由选择部分也称控制部分，其核心构建是路由选择处理机。路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和其他相邻路由器交换路由信息而不断更新和维护路由表。

分组转发部分由三部分组成：交换结构、一组输入端口和一组输出端口。输入端口在从物理层接收到的比特流中提取出链路层帧，进而从帧中提取出网络层数据报，输出端口则执行恰好相反的操作。交换结构是路由器的关键部件，它根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。有三种常用的交换方法：通过存储器进行交换、通过总线进行交换和通过互联网络进行交换。交换结构本身就是一个网络。

路由器主要完成两个功能：一是分组转发，二是路由计算。前者处理通过路由器的数据流，关键操作是转发表查询、转发及相关的队列管理和任务调度等；后者通过和其他路由器进行基于路由协议的交互，完成路由表的计算。

路由器和网桥的重要区别是：网桥与高层协议无关，而路由器是面向协议的，它依据网络地址进行操作，并进行路径选择、分段、帧格式转换、对数据报的生存时间和流量进行控制等。现今的路由器一般都提供多种协议的支持，包括 OSI、TCP/IP、IPX 等。

## 路由表与路由转发

路由表是根据路由选择算法得出的，主要用途是路由选择。标准的路由表有 4 个项目：目的网络 IP地址、子网掩码、下一跳 IP 地址、接口。在下图所示的网络拓扑中，R1 的路由表见下表，该路由表包含到互联网的默认路由。

转发表示从路由表得出的，其表项和路由表项有直接的对应关系。但转发表的格式和路由表的格式不同，其结构应使查找过程最优化（而路由表则需对网络拓扑变化的计算最优化）。转发表中含有一个分组将要发往的目的地址，以及分组的下一跳（即下一步接收者的目的地址，实际为 MAC 地址）。为了减少转发表的重复项目，可以使用一个默认路由代替所有具有相同 “下一跳” 的项目，并将默认路由设置得比其他项目的优先级低，如下图所示。路由表总是用软件来实现的；转发表可以用软件来实现，甚至也可以用特殊的硬件来实现。

注意，在讨论路由选择的原理时，往往不去区分转发表和路由表的区别，但要注意路由表不等于转发表。分组的实际转发是靠直接查找转发表，而不是直接查找路由表。

注意转发和路由选择的区别：“转发” 是路由器根据转发表把收到的 IP 数据报从合适的端口转发出去，它仅涉及一个路由器。而 “路由选择” 则涉及很多路由器，路由表是许多路由器协同工作的结果。这些路由器按照复杂的路由算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由，并由此构造出整个路由表。